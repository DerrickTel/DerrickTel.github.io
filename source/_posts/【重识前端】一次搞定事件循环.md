---
title: ã€é‡è¯†å‰ç«¯ã€‘ä¸€æ¬¡æå®šJavaScriptçš„æ‰§è¡Œæœºåˆ¶
date: 2020-08-10 21:36:40
tags: [JavaScript]
category: [é‡æ‹¾å‰ç«¯]
cover: /image/cover/web.jpeg
---

æœ€è¿‘åœ¨å†™ã€é‡æ‹¾å‰ç«¯ã€‘ç³»åˆ—ï¼Œä¸‹é¢æœ‰å‡ ä¸ªå¿«é€Ÿé€šé“ï¼Œå¤§å®¶è‡ªå–

[ã€é‡è¯†å‰ç«¯ã€‘åŸå‹/åŸå‹é“¾å’Œç»§æ‰¿](https://juejin.im/post/6850418113944420359)

[ã€é‡è¯†å‰ç«¯ã€‘é—­åŒ…ä¸æ¨¡å—](https://juejin.im/post/6850418117508759566)

[ã€é‡è¯†å‰ç«¯ã€‘å…¨é¢æ”»ç ´this](https://juejin.im/post/6854573215658803208)

[ã€é‡è¯†å‰ç«¯ã€‘ä¸€æ¬¡æå®šJavaScriptçš„æ‰§è¡Œæœºåˆ¶](https://juejin.im/post/6859911609633767438)

[ã€é‡è¯†å‰ç«¯ã€‘ä»€ä¹ˆæ˜¯BFCã€IFCã€GFC å’Œ FFC](https://juejin.im/post/6860375101322461198)

[ã€é‡è¯†å‰ç«¯ã€‘æ·±å…¥å†…å­˜ä¸–ç•Œ](https://juejin.im/post/6865204092877144077)

## å‰è¨€

äº‹ä»¶å¾ªç¯è¿™ä¸ªäº‹æƒ…ï¼Œå…¶å®åœ¨æˆ‘ä»¬çš„å·¥ä½œä¸­æˆ–å¤šæˆ–å°‘éƒ½ä¼šç¢°åˆ°ï¼Œå¯èƒ½æˆ‘ä»¬åªæ˜¯æ²¡æœ‰å»è®¤è®¤çœŸçœŸçš„ç†è§£ä»–ï¼Œäº†è§£ä»–è€Œå·²ã€‚ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æŠŠäº‹ä»¶å¾ªç¯åƒé€ã€‚

## å•çº¿ç¨‹çš„JS

å…¶å®ï¼Œäº‹ä»¶å¾ªç¯å°±æ˜¯å¯¹äºå•çº¿ç¨‹çš„JSåº”è¿è€Œç”Ÿçš„ã€‚

- å•çº¿ç¨‹ï¼Ÿä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Œè¯¶ï¼Œæˆ‘å¥½åƒå¬è¿‡è¿›ç¨‹è¯¶ï¼Œä»–ä»¬ä¸¤å…„å¼Ÿå•¥åŒºåˆ«ï¼Ÿ
- ä¸ºä»€ä¹ˆjsä¸€å®šè¦å•çº¿ç¨‹å•Šï¼Œæˆ‘å¬è¯´CPUä¸æ˜¯æœ‰å¾ˆå¤šæ ¸å—ï¼Ÿä¸ºä»€ä¹ˆä¸å¤šçº¿ç¨‹ï¼Ÿ

### çº¿ç¨‹å’Œè¿›ç¨‹çš„çˆ±æ¨çº è‘›

è¿™é‡Œæˆ‘æ¨èé˜®ä¸€å³°è€å¸ˆçš„ä¸€ç¯‡æ–‡ç«  

[ç‚¹æˆ‘å­¦ä¹ ](https://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html)

### ä¸ºä»€ä¹ˆJSæ˜¯å•çº¿ç¨‹ï¼Ÿ

> è¿™ä¸ªè¦å›åˆ°Jså†å²äº†ï¼Œå¸ƒå…°ç™»Â·è‰¾å¥‡(Brendan Eich)è€å“¥ç”¨10å¤©åˆ›é€ jsã€‚å½“æ—¶jsç”¨æ¥å¹²å˜›ï¼Œç®€å•çš„æµè§ˆå™¨äº¤äº’ï¼ŒéªŒè¯ï¼Œæ“ä½œä¸€ä¸‹domæ˜¯å§ã€‚é‚£æŠŠå®ƒè®¾è®¡æˆé‚£ä¹ˆå¤æ‚å¹²ä»€ä¹ˆï¼Œè€Œä¸”å¦‚æœå¤šçº¿ç¨‹çš„è¯ï¼Œæ“ä½œdomä¼šå‡ºç°éº»çƒ¦çš„äº‹æƒ…ï¼Œå‡è®¾ä¸€ä¸ªçº¿ç¨‹è¯»å–DOMèŠ‚ç‚¹æ•°æ®çš„åŒæ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æŠŠé‚£ä¸ªDOMèŠ‚ç‚¹åˆ äº†ï¼Œå‘µå‘µã€‚æ‰€ä»¥jsä¸€ä¸ªçº¿ç¨‹å°±å¤Ÿäº†ï¼Œä¹Ÿå°±æ˜¯ä¸€æ­¥ä¸€æ­¥é¡ºåºè¿è¡Œä¸‹æ¥ã€‚

## æµè§ˆå™¨ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—å’Œäº‹ä»¶å¾ªç¯

è¿™é‡Œæš‚æ—¶åªè¯´æµè§ˆå™¨ä¸­çš„å¾ªç¯äº‹ä»¶å¾ªç¯ï¼Œæœ‰å…³nodeçš„è¯å¯èƒ½æœ‰äº›ç»†å¾®çš„å·®åˆ«ï¼Œä¸è¿‡åº•å±‚çš„åŸç†éƒ½æ˜¯å·®ä¸å¤šçš„ã€‚

### æ³¨æ„

è¿™é‡Œä¸»è¦æ˜¯ä»ä¸€ä¸ªè®¾è®¡è€…çš„è§’åº¦æ¥æ¨¡æ‹Ÿï¼Œä»é›¶æ„å»ºæµè§ˆå™¨ä¸­çš„æ—¶é—´å¾ªç¯ã€‚ä¸ºäº†èƒ½è®©ä½ æ›´åŠ æ·±åˆ»åœ°ç†è§£äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œæˆ‘ä»¬å°±ä»æœ€ç®€å•çš„åœºæ™¯æ¥åˆ†æï¼Œç„¶åå¸¦ä½ ä¸€æ­¥æ­¥äº†è§£æµè§ˆå™¨é¡µé¢ä¸»çº¿ç¨‹æ˜¯å¦‚ä½•è¿ä½œçš„ã€‚

### å¼€å§‹

#### äº‹å…ˆçº¦å®šå¥½çš„æ‰§è¡Œé¡ºåº

å‡å¦‚æˆ‘æœ‰ä»¥ä¸‹å‡ ä¸ªä»»åŠ¡

```js
var num1 = 1+2; // ä»»åŠ¡ 1
var num2 = 20/5; // ä»»åŠ¡ 2
var num3 = 7*8; // ä»»åŠ¡ 3
console.log(num1, num2, num3)ï¼› // ä»»åŠ¡ 4
```



å¦‚æœè®©æˆ‘æ¥è®¾è®¡ï¼Œæˆ‘å°±ä¼šæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œç„¶åæŠŠä»–ä»¬æŒ‰é¡ºåºæ’è¿›å»ï¼Œç„¶åé¡ºåºæ‰§è¡Œã€‚



```js
function mainThread(){
  var num1 = 1+2; // ä»»åŠ¡ 1
  var num2 = 20/5; // ä»»åŠ¡ 2
  var num3 = 7*8; // ä»»åŠ¡ 3
  console.log(num1, num2, num3)ï¼› // ä»»åŠ¡ 4
}
```

ğŸ˜¯ï¼Œæˆ‘ä»¬å·²ç»è®¾è®¡äº†æœ€ç®€å•çš„çº¿ç¨‹å•¦ã€‚

#### çº¿ç¨‹è¿è¡Œä¸­ï¼Œå¤„ç†çªå‘äº‹ä»¶

å¾ˆå¤šæ—¶å€™ï¼Œæ‰€æœ‰çš„ä»»åŠ¡ä¸æ˜¯ä¹‹å‰å°±ç»Ÿä¸€å®‰æ’å¥½çš„ï¼Œæ¯”å¦‚âŒ¨ï¸çš„è¾“å…¥ï¼ŒğŸ–±çš„ç‚¹å‡»ç­‰ç­‰ã€‚

å¦‚æœæƒ³è¦åœ¨çº¿ç¨‹è¿è¡Œä¸­å¯ä»¥å¾ˆå¥½çš„å¤„ç†è¿™äº›äº‹ä»¶ã€‚å°±éœ€è¦

 ====>äº‹ä»¶å¾ªç¯ã€‚è¿™é‡Œæˆ‘ä»¬ç”¨whileæ¥å®ç°ç®€å•çš„äº‹ä»¶å¾ªç¯

```js
function awaitt() {
  return new Promise(resolve => {
    document.addEventListener('keydown', resolve);
  });
}

async function mainThread() {
  while(true){
    const result = await awaitt();
    console.log(result);
  }
}

mainThread();
```

è¿™æ ·æ”¹ç‰ˆä¹‹åæœ‰äº†ä»¥ä¸‹å‡ ç‚¹æ”¹è¿›ï¼š

- å¼•å…¥äº†å¾ªç¯æœºåˆ¶
- å¼•å…¥äº‹ä»¶ï¼Œç„¶åæ•´ä¸ªçº¿ç¨‹åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ´»äº†èµ·æ¥ï¼Œä¸å†æ˜¯æ­»çš„ï¼Œè¿è¡Œå®Œå°±æ»šè›‹äº†çš„é‚£ç§ï¼Œæœ‰äº†äº¤äº’äº†

ï¼ˆğŸ¤«æœ€ç®€å•çš„å®ç°ã€‚ã€‚ã€‚åˆ«åæ§½ä»£ç ï¼Œéƒ½æ˜¯æœ€ç®€å•çš„å®ç°å’Œæœ€ç®€å•çš„åœºæ™¯ï¼ŒåŠ©äºç†è§£è€Œå·²ã€‚ã€‚ã€‚ï¼‰

#### å¤„ç†å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡

ä¸Šé¢çš„ç‰ˆæœ¬ç”¨äº†äº‹ä»¶å¾ªç¯çš„æ–¹å¼æ¥è·å–å†…éƒ¨çš„äº‹ä»¶ï¼Œä½†æ˜¯å¯¹äºå¤–éƒ¨çªå‘æƒ…å†µçš„äº‹ä»¶æ˜¯æ— æ³•è§£å†³çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å‡çº§~

é‚£ä¹ˆæ€ä¹ˆè®¾è®¡å¥½ä¸€ä¸ªçº¿ç¨‹æ¨¡å‹å‘¢ï¼Ÿæˆ‘ä»¬æ¢ä¸ªè§’åº¦æƒ³æƒ³æ€è·¯é©¬ä¸Šå°±å‡ºæ¥äº†ã€‚

è¿™äº›å¤–éƒ¨çš„ä»»åŠ¡ï¼Œéƒ½æ˜¯æœ‰å…ˆåé¡ºåºçš„ï¼Œå“ªæ€•æ˜¯éƒ½æ˜¯çªå‘æƒ…å†µã€‚ä»–ä»¬ä¹Ÿæ˜¯æœ‰å…ˆåé¡ºåºã€‚

æ‰€ä»¥ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„æ¨¡å¼å°±æ˜¯

======> æ¶ˆæ¯é˜Ÿåˆ—

> æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥å­˜æ”¾è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚å®ƒç¬¦åˆé˜Ÿåˆ—â€œå…ˆè¿›å…ˆå‡ºâ€çš„ç‰¹ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´è¦æ·»åŠ ä»»åŠ¡çš„è¯ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼›è¦å–å‡ºä»»åŠ¡çš„è¯ï¼Œä»é˜Ÿåˆ—å¤´éƒ¨å»å–ã€‚

æˆ‘ä»¬è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªæ“ä½œï¼š

1. æ·»åŠ ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼›
2. IO çº¿ç¨‹ä¸­äº§ç”Ÿçš„æ–°ä»»åŠ¡æ·»åŠ è¿›æ¶ˆæ¯é˜Ÿåˆ—å°¾éƒ¨ï¼›
3. æ¸²æŸ“ä¸»çº¿ç¨‹ä¼šå¾ªç¯åœ°ä»æ¶ˆæ¯é˜Ÿåˆ—å¤´éƒ¨ä¸­è¯»å–ä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚



```js
const arrTask = []

function addTask(fn) {
  arrTask.push(fn)
}

function otherThread() {
  addTask(() => {console.log('other')})
}

function awaitt() {
  return new Promise(resolve => {
      if(arrTask.length) {
        const task = arrTask.shift()
        task()
        resolve()
      }
  });
}

async function mainThread() {
  while(true){
    	await awaitt();
  }
}


addTask(()=>console.log('in'))
addTask(()=>console.log('in'))
addTask(()=>console.log('in'))

mainThread();
otherThread()
```



æˆ‘ä»¬ç”¨ä¸€ä¸ªæ•°ç»„æ¥æ¨¡æ‹Ÿä¸€ä¸ªé˜Ÿåˆ—ã€‚

æ—¢åŸºç¡€äº†å†…éƒ¨çš„ä»»åŠ¡ï¼Œä¹Ÿå¤„ç†äº†å¤–éƒ¨çªå‘çš„ä»»åŠ¡

æœ‰ä»»åŠ¡è¿›æ¥ï¼Œ å°±ä¼šæ‰§è¡Œä»»åŠ¡ã€‚



#### é€€å‡ºä¸»çº¿ç¨‹

å½“é¡µé¢ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œåˆè¯¥å¦‚ä½•ä¿è¯é¡µé¢ä¸»çº¿ç¨‹èƒ½å¤Ÿå®‰å…¨é€€å‡ºå‘¢ï¼ŸChrome æ˜¯è¿™æ ·è§£å†³çš„ï¼Œç¡®å®šè¦é€€å‡ºå½“å‰é¡µé¢æ—¶ï¼Œé¡µé¢ä¸»çº¿ç¨‹ä¼šè®¾ç½®ä¸€ä¸ªé€€å‡ºæ ‡å¿—çš„å˜é‡ï¼Œåœ¨æ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è®¾ç½®é€€å‡ºæ ‡å¿—ã€‚



```js
const arrTask = []
let over = false

function addTask(fn) {
  arrTask.push(fn)
}

function otherThread() {
  addTask(() => {console.log('other')})
}

function awaitt() {
  return new Promise(resolve => {
      if(arrTask.length) {
        const task = arrTask.shift()
        task()
        if(!arrTask.length){
          over = true
        }
        resolve()
      }
  });
}

async function mainThread() {
  while(true){
    if(over){
      break;
    }
    	await awaitt();
  }
}


addTask(()=>console.log('in'))
addTask(()=>console.log('in'))
addTask(()=>console.log('in'))

mainThread();
otherThread()
```



### å•çº¿ç¨‹çš„ç¼ºç‚¹

é€šè¿‡ä¸Šé¢çš„ä»‹ç»ï¼Œä½ åº”è¯¥æ¸…æ¥šäº†ï¼Œé¡µé¢çº¿ç¨‹æ‰€æœ‰æ‰§è¡Œçš„ä»»åŠ¡éƒ½æ¥è‡ªäºæ¶ˆæ¯é˜Ÿåˆ—ã€‚æ¶ˆæ¯é˜Ÿåˆ—æ˜¯â€œå…ˆè¿›å…ˆå‡ºâ€çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´æ”¾å…¥é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œéœ€è¦ç­‰å¾…å‰é¢çš„ä»»åŠ¡è¢«æ‰§è¡Œå®Œï¼Œæ‰ä¼šè¢«æ‰§è¡Œã€‚é‰´äºè¿™ä¸ªå±æ€§ï¼Œå°±æœ‰å¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜éœ€è¦è§£å†³ã€‚

#### å¦‚ä½•å¤„ç†é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡

åœºæ™¯ï¼š

å‡å¦‚ï¼Œæˆ‘ç°åœ¨æœ‰ä¸€å¤§ä¸²çš„ä»»åŠ¡åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚

æˆ‘çš„domèŠ‚ç‚¹å˜åŒ–çš„æ—¶å€™ï¼Œæˆ‘éœ€è¦å‘é€è¯·æ±‚æˆ–è€…æç¤ºä¸€ä¸ª`alert`ä¹‹ç±»çš„ä¸šåŠ¡é€»è¾‘è¦æ‰§è¡Œã€‚

ç°åœ¨å¯è¡Œçš„æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

- domèŠ‚ç‚¹å˜åŒ–çš„è¯ï¼Œæˆ‘å°±åœä¸‹ç°åœ¨æ­£åœ¨è¿è¡Œçš„ä¸»çº¿ç¨‹ä¸Šçš„ä»»åŠ¡ï¼Œç„¶åè°ƒç”¨æˆ‘éœ€è¦æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™æ ·ç¡®å®å…·æœ‰å®æ•ˆæ€§ï¼Œä½†æ˜¯ï¼è¿™æ ·ä¼šä½¿å¾—å½“å‰ä»»åŠ¡çš„æ•ˆç‡æåº¦é™ä½ï¼Œæ¯”å¦‚æˆ‘çš„domèŠ‚ç‚¹å˜åŒ–200æ¬¡ï¼Œé‚£å²‚ä¸æ˜¯å½“å‰çš„ä»»åŠ¡ç‰¹åˆ«ä¹…äº†å—ï¼Ÿ
- ç¬¬äºŒä¸ªæ–¹æ³•å°±å¯ä»¥è§£å†³ä¸Šè¿°çš„é—®é¢˜ï¼šä¸€æ—¦domèŠ‚ç‚¹æœ‰å˜åŒ–ï¼Œå“ªæ€•æ˜¯200000æ¬¡å˜åŒ–ï¼Œæˆ‘éƒ½æ˜¯å°†ä¸šåŠ¡é€»è¾‘pushåˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“å½“å‰ä»»åŠ¡è¿›è¡Œä»¥åŠæ•ˆç‡äº†ã€‚ä½†æ˜¯ï¼è¿™æ ·çš„è¯æˆ‘çš„å®æ•ˆæ€§å°±è«å¾—äº†ã€‚å°±è«å¾—äº†ã€‚

æ€»ç»“ä¸€ä¸‹ï¼šå…¶å®å°±æ˜¯å®æ•ˆæ€§å’Œä»»åŠ¡æ•ˆç‡çš„æƒè¡¡é—®é¢˜ç½¢äº†ã€‚

æ±Ÿæ±Ÿæ±Ÿ~

å¾®ä»»åŠ¡å°±åº”è¿è€Œç”Ÿå•¦ã€‚

åŠ å…¥æˆ‘ä»¬æŠŠä»»åŠ¡é˜Ÿåˆ—é‡Œé¢çš„æ¯ä¸ªä»»åŠ¡éƒ½ç§°ä½œå®ä»»åŠ¡çš„è¯ï¼Œæ¯ä¸ªå®ä»»åŠ¡é‡Œé¢éƒ½ä¼šåŒ…å«ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚æ¯ä¸ªå®ä»»åŠ¡ç»“æŸä¹‹åï¼Œéƒ½å›å»æ¸…ç†ä¸€éå¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢çš„é˜Ÿåˆ—ï¼Œè¿™æ ·çš„è¯æ—¢ä¿æŠ¤äº†å®æ•ˆæ€§ï¼Œä¹Ÿä¿æŠ¤äº†ä»»åŠ¡çš„æ•ˆç‡ã€‚



#### å¦‚ä½•å¤„ç†è°ƒç”¨æ—¶é—´è¿‡é•¿çš„é—®é¢˜

æˆ‘ä»¬éƒ½çŸ¥é“jsæ˜¯å•çº¿ç¨‹çš„ã€‚å¦‚æœç°åœ¨åœ¨æ‰§è¡Œä¸€ä¸ªä»»åŠ¡çš„æƒ…å†µä¸‹ã€‚å…¶ä»–ä»»åŠ¡å°±æ˜¯è¦ç­‰å¾…çš„ã€‚é‚£ä¹ˆå°±ä¼šå‡ºç°æŸä¸ªä»»åŠ¡è®¡ç®—çš„å‘¨æœŸç‰¹åˆ«é•¿ï¼Œå¯¼è‡´åˆ«äººéƒ½åœ¨ç­‰å¾…ã€‚

ğŸ‘Œï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹

```js
while(true){}
alter(123)
```

ä¸‹é¢çš„`alter`æ°¸è¿œéƒ½ä¸ä¼šæ‰§è¡Œäº†ã€‚å› ä¸º`while`åœ¨å·¥ä½œï¼Œ`alter`åœ¨ç­‰ä»–æŠŠèµ„æºè®©å‡ºæ¥ã€‚

å‡å¦‚è¯´ï¼Œæˆ‘ç°åœ¨æœ‰ä¸€ä¸ªåŠ¨ç”»è¦è¿›è¡Œï¼Œä½†æ˜¯è¿è¡Œå®Œä¸€å¸§ä¹‹åï¼Œæœ‰ä¸€ä¸ªæå…¶å¤æ‚çš„è®¡ç®—ï¼Œå¯¼è‡´äº†æˆ‘çš„åŠ¨ç”»ä¸æµç•…ï¼Œé‚£ä¹ˆç”¨æˆ·å¯èƒ½å°±ä¼šéå¸¸çš„çƒ¦ã€‚è¿™ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ã€‚

æ‰€ä»¥jsæœ‰ä¸€ä¸ªå›è°ƒæœºåˆ¶ï¼Œåˆ°äº†ç‰¹å®šçš„æ—¶é—´ç‚¹äº†ï¼Œå›è°ƒä¸€ä¸‹ï¼ŒæŠŠåŠ¨ç”»çš„ä¸‹ä¸€å¸§æ‰§è¡Œä¸€ä¸‹ï¼Œç„¶åç»§ç»­å½“å‰çš„å¤æ‚è®¡ç®—ã€‚

### æ€»ç»“

- å¦‚æœæœ‰ä¸€äº›ç¡®å®šå¥½çš„ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå•çº¿ç¨‹æ¥æŒ‰ç…§é¡ºåºå¤„ç†è¿™äº›ä»»åŠ¡ï¼Œè¿™æ˜¯ç¬¬ä¸€ç‰ˆçº¿ç¨‹æ¨¡å‹ã€‚
- è¦åœ¨çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­æ¥æ”¶å¹¶å¤„ç†æ–°çš„ä»»åŠ¡ï¼Œå°±éœ€è¦å¼•å…¥å¾ªç¯è¯­å¥å’Œäº‹ä»¶ç³»ç»Ÿï¼Œè¿™æ˜¯ç¬¬äºŒç‰ˆçº¿ç¨‹æ¨¡å‹ã€‚
- å¦‚æœè¦æ¥æ”¶å…¶ä»–çº¿ç¨‹å‘é€è¿‡æ¥çš„ä»»åŠ¡ï¼Œå°±éœ€è¦å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™æ˜¯ç¬¬ä¸‰ç‰ˆçº¿ç¨‹æ¨¡å‹ã€‚
- å¦‚æœå…¶ä»–è¿›ç¨‹æƒ³è¦å‘é€ä»»åŠ¡ç»™é¡µé¢ä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆå…ˆé€šè¿‡ IPC æŠŠä»»åŠ¡å‘é€ç»™æ¸²æŸ“è¿›ç¨‹çš„ IO çº¿ç¨‹ï¼ŒIO çº¿ç¨‹å†æŠŠä»»åŠ¡å‘é€ç»™é¡µé¢ä¸»çº¿ç¨‹ã€‚
- æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶å¹¶ä¸æ˜¯å¤ªçµæ´»ï¼Œä¸ºäº†é€‚åº”æ•ˆç‡å’Œå®æ—¶æ€§ï¼Œå¼•å…¥äº†å¾®ä»»åŠ¡

åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„è®¾è®¡æ˜¯ç›®å‰ä½¿ç”¨æœ€å¹¿çš„æ¶ˆæ¯æ¶æ„ï¼Œæ— è®ºæ˜¯å®‰å“è¿˜æ˜¯ Chrome éƒ½é‡‡ç”¨äº†ç±»ä¼¼çš„ä»»åŠ¡æœºåˆ¶ï¼Œæ‰€ä»¥ç†è§£äº†æœ¬ç¯‡æ–‡ç« çš„å†…å®¹åï¼Œä½ å†ç†è§£å…¶ä»–é¡¹ç›®çš„ä»»åŠ¡æœºåˆ¶ä¹Ÿä¼šæ¯”è¾ƒè½»æ¾ã€‚

## æµè§ˆå™¨æ˜¯æ€ä¹ˆå®ç°setTimeout

è¦æƒ³çŸ¥é“æµè§ˆå™¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¹‹å‰è®¾è®¡çš„é‚£ä¸ªäº‹ä»¶å¾ªç¯ç³»ç»Ÿï¼š

æœ‰xxä»»åŠ¡äº†ï¼Œokï¼Œæˆ‘`push`åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚ä»¥æ­¤å¾ªç¯ã€‚

æ‰€ä»¥æˆ‘ä»¬å†™åœ¨`setTimeout`é‡Œé¢çš„å‡½æ•°æ‰§è¡Œå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œä¹Ÿæ˜¯éœ€è¦pushåˆ°ä»»åŠ¡é˜Ÿåˆ—å»çš„ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„è¿™ä¸ªæ˜¯å…¶å®æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„å‡½æ•°ï¼Œä¸èƒ½ç›´æ¥å°†æ•´ä¸ªå‡½æ•°pushåˆ°é˜Ÿåˆ—ä¸­ï¼Œå¦åˆ™çš„è¯æˆ‘ä»¬çš„å®æ•ˆæ€§å°±å¾ˆæœ‰å¯èƒ½å‡ºé”™äº†ï¼Œæ¯”å¦‚æˆ‘å¸Œæœ›ä»–åœ¨24å°æ—¶ä¹‹å`alter`å‘Šè¯‰æˆ‘å·²ç»åˆ°äº†ç¬¬äºŒå¤©äº†ã€‚ä»–å¦‚æœæ˜¯ç›´æ¥pushåˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ²¡æœ‰åˆ°ç¬¬äºŒå¤©å°±ä¼šå‘Šè¯‰æˆ‘ç¬¬äºŒå¤©åˆ°äº†ï¼Œè¿™ä¸æ˜¯è®©ç”¨æˆ·åŒªå¤·æ‰€æ€å˜›ã€‚

æ‰€ä»¥è‚¯å®šä¸æ˜¯ç›´æ¥`push`çš„ã€‚é‚£åˆæ˜¯æ€ä¹ˆå¼„å¾—å˜ï¼Ÿ

ä½ ä¹Ÿå¯ä»¥æ€è€ƒä¸‹ï¼Œå¦‚æœè®©ä½ åœ¨æ¶ˆæ¯å¾ªç¯ç³»ç»Ÿçš„åŸºç¡€ä¹‹ä¸ŠåŠ ä¸Šå®šæ—¶å™¨çš„åŠŸèƒ½ï¼Œä½ ä¼šå¦‚ä½•è®¾è®¡ï¼Ÿ

åœ¨ Chrome ä¸­é™¤äº†æ­£å¸¸ä½¿ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¸­ç»´æŠ¤äº†éœ€è¦å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ï¼ŒåŒ…æ‹¬äº†å®šæ—¶å™¨å’Œ Chromium å†…éƒ¨ä¸€äº›éœ€è¦å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡ã€‚æ‰€ä»¥å½“é€šè¿‡ JavaScript åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨æ—¶ï¼Œæ¸²æŸ“è¿›ç¨‹ä¼šå°†è¯¥å®šæ—¶å™¨çš„å›è°ƒä»»åŠ¡æ·»åŠ åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­

æˆ‘ä»¬æŠŠä¹‹å‰çš„äº‹ä»¶å¾ªç¯æ¨¡æ‹Ÿæ”¹ä¸€ä¸‹

```js
const mainTask = [
  fn1,
  fn2,
  fn3,
  â€¦â€¦
]

const setTimeoutTask = []

function addSetTimeoutTask(fn, timeout){
  setTimeoutTask.push({
    fn: fn,
    id: Math.random(),
    useTime: timeout + ((new Date()).getTime()
  })
}

const runSetTimeoutTask (){
  const runList = []
  setTimeoutTask.forEach(item => {
    // å·²ç»è¿‡äº†æ—¶é—´ï¼Œæˆ–è€…åˆšåˆšå¥½åˆ°æ—¶é—´çš„è¯å°±å–å‡ºæ¥ã€‚å¾…ä¼šä¸€èµ·æ‰§è¡Œäº†
    if(item.useTime <= ((new Date()).getTime()) {
      runList.push(item.fn) 
    }
  })
  if(runList.length) {
    const fn = runList.shift()
    fn()
  }
}

async function mainThread() {
  while(true){
    const task = arrTask.shift()
    
    // æ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œéƒ½å›å»æŸ¥æ‰¾ä¸€ä¸‹å»¶è¿Ÿé˜Ÿåˆ—é‡Œé¢æœ‰æ²¡æœ‰åˆ°ç‚¹çš„å‡½æ•°
    if(setTimeoutTask.length) {
       runSetTimeoutTask()
    }
  }
}

mainThread();
```

æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å…¶å®ä½ åˆ°ç‚¹äº†å¯èƒ½è¦ä¸ä¼šç«‹åˆ»æ‰§è¡Œï¼Œå¿…é¡»ç­‰åˆ°ä¹‹å‰çš„ä»»åŠ¡æ‰§è¡Œå®Œäº†æ‰è½®åˆ°å»¶è¿Ÿé˜Ÿåˆ—çš„æŸ¥è¯¢å’Œæ‰§è¡Œã€‚

æˆ‘ä»¬ä»£ç ä¸­æœ‰ä¸€ä¸ªå½©è›‹----> ID

è¿™ä¸ªIDæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

å°±æ˜¯ç”¨äº`clearTimeout`

ç›´æ¥ä¼ å…¥IDï¼Œç„¶åå¾ªç¯æ‰¾åˆ°ä»–ï¼Œå°±å¯ä»¥ç›´æ¥ä»é˜Ÿåˆ—é‡Œé¢åˆ æ‰å°±å¥½äº†ã€‚

è¿™é‡Œå°±ä¸éœ€è¦è´´ä»£ç äº†å§ï¼Ÿ

### å†·çŸ¥è¯†

- **å¦‚æœ setTimeout å­˜åœ¨åµŒå¥—è°ƒç”¨ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè®¾ç½®æœ€çŸ­æ—¶é—´é—´éš”ä¸º 4 æ¯«ç§’**
- **æœªæ¿€æ´»çš„é¡µé¢ï¼ŒsetTimeout æ‰§è¡Œæœ€å°é—´éš”æ˜¯ 1000 æ¯«ç§’**
  - é™¤äº†å‰é¢çš„ 4 æ¯«ç§’å»¶è¿Ÿï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå®¹æ˜“è¢«å¿½ç•¥çš„åœ°æ–¹ï¼Œé‚£å°±æ˜¯æœªè¢«æ¿€æ´»çš„é¡µé¢ä¸­å®šæ—¶å™¨æœ€å°å€¼å¤§äº 1000 æ¯«ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ ‡ç­¾ä¸æ˜¯å½“å‰çš„æ¿€æ´»æ ‡ç­¾ï¼Œé‚£ä¹ˆå®šæ—¶å™¨æœ€å°çš„æ—¶é—´é—´éš”æ˜¯ 1000 æ¯«ç§’ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¼˜åŒ–åå°é¡µé¢çš„åŠ è½½æŸè€—ä»¥åŠé™ä½è€—ç”µé‡ã€‚è¿™ä¸€ç‚¹ä½ åœ¨ä½¿ç”¨å®šæ—¶å™¨çš„æ—¶å€™è¦æ³¨æ„ã€‚
- **å»¶æ—¶æ‰§è¡Œæ—¶é—´æœ‰æœ€å¤§å€¼**
  - é™¤äº†è¦äº†è§£å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°æ—¶é—´æ¯”å®é™…è®¾å®šå€¼è¦å»¶åä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ä¸‹ï¼Œé‚£å°±æ˜¯ Chromeã€Safariã€Firefox éƒ½æ˜¯ä»¥ 32 ä¸ª bit æ¥å­˜å‚¨å»¶æ—¶å€¼çš„ï¼Œ32bit æœ€å¤§åªèƒ½å­˜æ”¾çš„æ•°å­—æ˜¯ 2147483647 æ¯«ç§’ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå¦‚æœ setTimeout è®¾ç½®çš„å»¶è¿Ÿå€¼å¤§äº 2147483647 æ¯«ç§’ï¼ˆå¤§çº¦ 24.8 å¤©ï¼‰æ—¶å°±ä¼šæº¢å‡ºï¼Œè¿™å¯¼è‡´å®šæ—¶å™¨ä¼šè¢«ç«‹å³æ‰§è¡Œã€‚
- **ä½¿ç”¨ setTimeout è®¾ç½®çš„å›è°ƒå‡½æ•°ä¸­çš„ this ä¸ç¬¦åˆç›´è§‰**
  - è¿™é‡Œå¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç« ï¼Œæœ‰å¯¹thisè¿›è¡Œæ”»ç ´

### æ€»ç»“

- é¦–å…ˆï¼Œä¸ºäº†æ”¯æŒå®šæ—¶å™¨çš„å®ç°ï¼Œæµè§ˆå™¨å¢åŠ äº†å»¶æ—¶é˜Ÿåˆ—ã€‚
- å…¶æ¬¡ï¼Œç”±äºæ¶ˆæ¯é˜Ÿåˆ—æ’é˜Ÿå’Œä¸€äº›ç³»ç»Ÿçº§åˆ«çš„é™åˆ¶ï¼Œé€šè¿‡ setTimeout è®¾ç½®çš„å›è°ƒä»»åŠ¡å¹¶éæ€»æ˜¯å¯ä»¥å®æ—¶åœ°è¢«æ‰§è¡Œï¼Œè¿™æ ·å°±ä¸èƒ½æ»¡è¶³ä¸€äº›å®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„éœ€æ±‚äº†ã€‚

## å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

å…¶å®é€šè¿‡ä¹‹å‰çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯¹äº‹ä»¶å¾ªç¯å·²ç»äº†è§£çš„å·®ä¸å¤šäº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯æ›´è¯¦ç»†äº†è§£ä¸€ä¸‹ä»–ä»¬ã€‚

### å®ä»»åŠ¡

å®ä»»åŠ¡æœ‰å“ªäº›ï¼Ÿ

é™¤äº†å¾®ä»»åŠ¡çš„éƒ½æ˜¯å®ä»»åŠ¡ã€‚ã€‚ã€‚

é‚£ä¹ˆå¾®ä»»åŠ¡æœ‰å“ªäº›ï¼Ÿ

`Process.nextTick`ã€`Promise.then catch finally`(æ³¨æ„æˆ‘ä¸æ˜¯è¯´ Promise)ã€`MutationObserver`ã€‚



åœ¨ä¹‹å‰çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“åœ¨å®ä»»åŠ¡ç»“æŸä¹‹åï¼Œä¼šå»æ‰§è¡Œä»–è‡ªå·±å½“å‰çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚åœ¨è¿™ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®Œæˆä¹‹åå†å»æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ã€‚

### å¾®ä»»åŠ¡

å¼‚æ­¥å‡½æ•°æœ‰ä¸¤ç§æ–¹å¼ï¼š

**ç¬¬ä¸€ç§æ˜¯æŠŠå¼‚æ­¥å›è°ƒå‡½æ•°å°è£…æˆä¸€ä¸ªå®ä»»åŠ¡ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—å°¾éƒ¨ï¼Œå½“å¾ªç¯ç³»ç»Ÿæ‰§è¡Œåˆ°è¯¥ä»»åŠ¡çš„æ—¶å€™æ‰§è¡Œå›è°ƒå‡½æ•°**ã€‚è¿™ç§æ¯”è¾ƒå¥½ç†è§£ï¼Œæˆ‘ä»¬å‰é¢ä»‹ç»çš„ setTimeout å’Œ XMLHttpRequest çš„å›è°ƒå‡½æ•°éƒ½æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å®ç°çš„ã€‚

**ç¬¬äºŒç§æ–¹å¼çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨ä¸»å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åã€å½“å‰å®ä»»åŠ¡ç»“æŸä¹‹å‰æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œè¿™é€šå¸¸éƒ½æ˜¯ä»¥å¾®ä»»åŠ¡å½¢å¼ä½“ç°çš„**ã€‚



- å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡æ˜¯ç»‘å®šçš„ï¼Œæ¯ä¸ªå®ä»»åŠ¡åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šåˆ›å»ºè‡ªå·±çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚
- å¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶é•¿ä¼šå½±å“åˆ°å½“å‰å®ä»»åŠ¡çš„æ—¶é•¿ã€‚æ¯”å¦‚ä¸€ä¸ªå®ä»»åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿäº† 100 ä¸ªå¾®ä»»åŠ¡ï¼Œæ‰§è¡Œæ¯ä¸ªå¾®ä»»åŠ¡çš„æ—¶é—´æ˜¯ 10 æ¯«ç§’ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿™ 100 ä¸ªå¾®ä»»åŠ¡çš„æ—¶é—´å°±æ˜¯ 1000 æ¯«ç§’ï¼Œä¹Ÿå¯ä»¥è¯´è¿™ 100 ä¸ªå¾®ä»»åŠ¡è®©å®ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å»¶é•¿äº† 1000 æ¯«ç§’ã€‚æ‰€ä»¥-ä½ åœ¨å†™ä»£ç çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„æ§åˆ¶å¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶é•¿ã€‚
- åœ¨ä¸€ä¸ªå®ä»»åŠ¡ä¸­ï¼Œåˆ†åˆ«åˆ›å»ºä¸€ä¸ªç”¨äºå›è°ƒçš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ï¼Œæ— è®ºä»€ä¹ˆæƒ…å†µä¸‹ï¼Œå¾®ä»»åŠ¡éƒ½æ—©äºå®ä»»åŠ¡æ‰§è¡Œã€‚



## æœŸæœ«è€ƒè¯•

```js
console.log('script start')

async function async1() {
  await async2()
  console.log('async1 end')
}
async function async2() {
  console.log('async2 end')
}
async1()

setTimeout(function() {
  console.log('setTimeout')
}, 0)

new Promise(resolve => {
  console.log('Promise')
  resolve()
})
  .then(function() {
    console.log('promise1')
  })
  .then(function() {
    console.log('promise2')
  })

console.log('script end')
```

å¤§å®¶å¯ä»¥è‡ªå·±åœ¨æµè§ˆå™¨é‡Œé¢è¯•è¯•å§ã€‚