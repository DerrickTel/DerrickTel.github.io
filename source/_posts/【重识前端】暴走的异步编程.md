---
title: ã€é‡è¯†å‰ç«¯ã€‘æš´èµ°çš„å¼‚æ­¥ç¼–ç¨‹
date: 2020-08-38 22:47:09
tags: [JavaScript]
category: [é‡æ‹¾å‰ç«¯]
cover: /image/cover/web.jpeg
---

æœ€è¿‘åœ¨å†™ã€é‡æ‹¾å‰ç«¯ã€‘ç³»åˆ—ï¼Œä¸‹é¢æœ‰å‡ ä¸ªå¿«é€Ÿé€šé“ï¼Œå¤§å®¶è‡ªå–

[ã€é‡è¯†å‰ç«¯ã€‘åŸå‹/åŸå‹é“¾å’Œç»§æ‰¿](https://juejin.im/post/6850418113944420359)

[ã€é‡è¯†å‰ç«¯ã€‘é—­åŒ…ä¸æ¨¡å—](https://juejin.im/post/6850418117508759566)

[ã€é‡è¯†å‰ç«¯ã€‘å…¨é¢æ”»ç ´this](https://juejin.im/post/6854573215658803208)

[ã€é‡è¯†å‰ç«¯ã€‘ä¸€æ¬¡æå®šJavaScriptçš„æ‰§è¡Œæœºåˆ¶](https://juejin.im/post/6859911609633767438)

[ã€é‡è¯†å‰ç«¯ã€‘ä»€ä¹ˆæ˜¯BFCã€IFCã€GFC å’Œ FFC](https://juejin.im/post/6860375101322461198)

[ã€é‡è¯†å‰ç«¯ã€‘æ·±å…¥å†…å­˜ä¸–ç•Œ](https://juejin.im/post/6865204092877144077)

## å‰è¨€

è€è§„çŸ©ï¼Œè¿˜æ˜¯å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯å¼‚æ­¥ã€‚å¼‚æ­¥å…¶å®æ˜¯ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒé«˜çº§çš„ä¸€ä¸ªæ¦‚å¿µã€‚

é€šå¸¸æ¥è¯´ï¼Œç¨‹åºéƒ½æ˜¯é¡ºåºæ‰§è¡Œï¼ŒåŒä¸€æ—¶åˆ»åªä¼šå‘ç”Ÿä¸€ä»¶äº‹ã€‚å¦‚æœä¸€ä¸ªå‡½æ•°ä¾èµ–äºå¦ä¸€ä¸ªå‡½æ•°çš„ç»“æœï¼Œå®ƒåªèƒ½ç­‰å¾…é‚£ä¸ªå‡½æ•°ç»“æŸæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œä»ç”¨æˆ·çš„è§’åº¦æ¥è¯´ï¼Œæ•´ä¸ªç¨‹åºæ‰ç®—è¿è¡Œå®Œæ¯•.

å¦‚æœè¯´ä¸€ä¸ªäº‹æƒ…éœ€è¦ç­‰å¾…ä¸Šä¸€ä»¶äº‹æƒ…åšå®Œæ‰èƒ½åšï¼Œä½†æ˜¯ä»–ä»¬ä¹‹å‰åˆæ²¡æœ‰å¼ºè€¦åˆå…³ç³»ã€‚è¿™æ ·å°±åœ¨é‚£é‡Œå¹²ç­‰å°±æ¯«æ— æ„ä¹‰ã€‚ç‰¹åˆ«æ˜¯ç°åœ¨è®¡ç®—æœºæ™®ééƒ½æœ‰å¤šæ ¸CPUçš„æ—¶ä»£ã€‚

ä¸¾ä¸€ä¸ªå½¢è±¡çš„ğŸŒ°ã€‚

æˆ‘ä»¬ç°åœ¨è¦å»åƒæµ·åº•æï¼ˆæµ·åº•ææ‰“é’±ï¼ï¼‰ï¼Œæˆ‘ä»¬å‘ç°è¦æ’é˜Ÿï¼Œéœ€è¦æ’2ä¸ªå°æ—¶å·¦å³ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¦å¹²å˜›ï¼Ÿéš¾é“æ˜¯å¹²ç­‰å—ï¼Ÿè‚¯å®šä¸æ˜¯ï¼é‚£æ ·è ¢è ¢çš„ç¡¬ç­‰å¾ˆå‘†ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæ‹¿å‡ºæ‰‹æœºåˆ·åˆ·æœ‹å‹åœˆï¼Œæˆ–è€…ç©ä¸€æŠŠç´§å¼ åˆºæ¿€çš„ç‹è€…è£è€€åˆæˆ–è€…å»çœ‹ä¸€åœºç”µå½±ç­‰ç­‰....åœ¨æˆ‘ä»¬åšè¿™äº›äº‹æƒ…çš„æ—¶å€™æˆ‘ä»¬çš„æ’é˜Ÿå¹¶æ²¡æœ‰è¢«è€½è¯¯ï¼Œç”šè‡³å¯ä»¥å’ŒæœåŠ¡å‘˜è¯´å¿«åˆ°äº†æ‰“ä¸ªç”µè¯ç»™æˆ‘ï¼ˆè¿™ä¸ªæ˜¯å¸¸è§çš„callbackæ–¹æ³•ï¼Œå¾…ä¼šè®¨è®ºï¼‰

> è¿™æ ·ä½ å¯ä»¥åŒæ—¶å®Œæˆå…¶ä»–å·¥ä½œï¼Œè¿™å°±æ˜¯**å¼‚æ­¥ç¼–ç¨‹**çš„å‡ºå‘ç‚¹ã€‚

æœ¬æ–‡æ€»ç»“äº†å‡ ä¸ªå¼‚æ­¥çš„æ–¹æ¡ˆï¼Œç†è§£å®ƒä»¬å¯ä»¥è®©ä½ å†™å‡ºç»“æ„æ›´åˆç†ã€æ€§èƒ½æ›´å‡ºè‰²ã€ç»´æŠ¤æ›´æ–¹ä¾¿çš„Javascriptç¨‹åºã€‚

## å¼‚æ­¥callback

ä¸Šæ¥å°±æ˜¯ä¸€ä¸ªè‹±ä¿Šçš„ä¾‹å­

```js
var response = fetch('myImage.png');
var blob = response.blob();
```

æ²¡æœ‰äººå¯ä»¥å®Œç¾é¢„æµ‹åˆ°æ¯ç§ç½‘ç»œæƒ…å†µä¸‹è¿™ä¸ªresponseï¼Œæ˜¯å¦å¯ä»¥å®Œç¾è·å¾—fetchè·å¾—çš„å†…å®¹ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šæŠ¥é”™ã€‚

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„callbackå°±âœ¨bu ling bu lingçš„ç™»åœºå•¦ã€‚

æœ‰äº›å°ä¼™ä¼´å¯èƒ½è§‰å¾—callbackä¼¼ä¹å’Œè‡ªå·±æ²¡æœ‰å¤ªå¤§å…³ç³»ã€‚ã€‚ã€‚emmmm....

```js
btn.addEventListener('click', () => {
  alert('You clicked me!');
});
```

è¿™æ ·å‘¢ï¼Ÿæœ‰æ²¡æœ‰æ„Ÿè§‰æœ‰ç‚¹å„¿ç†Ÿæ‚‰äº†ï¼Œå…¶ä»–è¿™ä¸ªå°±ç›¸å½“äºreactä¸­çš„

```html
<div onclick={() =>{alert('You clicked me!');}}>
	ç‚¹æˆ‘  
</div>
```

æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯æœ€å¸¸è§çš„callbackï¼ˆå›è°ƒå‡½æ•°ï¼‰ã€‚

åˆæˆ–è€…æ¯”è¾ƒå¸¸è§çš„

```js
setTimeout(() => {
	alert('You clicked me!');
}ï¼Œ2000)
```

å¾ˆå¸¸è§ï¼Œå¤§è‡´æ„æ€å°±æ˜¯2ç§’é’Ÿä¹‹åä¼šå›è°ƒä¸€ä¸‹è¿™ä¸ªåŒ¿åå‡½æ•°ï¼Œè™½ç„¶ä¸ä¸€å®šä¼šå‡†ç¡®æ‰§è¡Œï¼Œè¿™ä¸ªæ¶‰åŠåˆ°äº‹ä»¶å¾ªç¯ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»æ‰¾ä¸€ä¸‹æˆ‘å‰é˜µå­å†™çš„äº‹ä»¶å¾ªç¯ğŸ˜Šã€‚

## å‘å¸ƒ-è®¢é˜…æ¨¡å¼

å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼šåˆç§°ä¸ºè§‚å¯Ÿè€…æ¨¡å¼ï¼Œå®ƒå®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å°†å¾—åˆ°é€šçŸ¥ã€‚

åœ¨å†™Reactçš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªéå¸¸éå¸¸éå¸¸å¸¸è§çš„ğŸŒ°ï¼š

```jsx
import React, {useState, useEffect} from 'react';
const test = () => {
  const [derrick, setDerrick] = useState(0)
  useEffect(()=> {
    console.log(derrick)
  }, [derrick])
  return(
    <button onClick={() => {setDerrick(derrick+1)}}>ç‚¹æˆ‘</button>
  )
}
```

useEffectè®¢é˜…äº†derrickè¿™ä¸ªå˜é‡çš„å˜åŒ–ï¼Œç„¶åç›‘å¬åˆ°å˜åŒ–ä¹‹åå°±ä¼šè¿›è¡Œä¸€æ¬¡logï¼Œæ‰“å°å‡ºderrickå˜é‡çš„å€¼ã€‚

## Promise

### å›è°ƒæ•‘æ˜Ÿ

ä¹‹å‰ä»‹ç»è¿‡å›è°ƒå‡½æ•°è¿™ç§å¼‚æ­¥ç¼–ç¨‹ã€‚

åŠ å…¥æˆ‘å¸Œæœ›åœ¨Aæ‰§è¡Œå®Œä¹‹åæ‰§è¡ŒBï¼Œç„¶åæ‰§è¡ŒCï¼Œç„¶åæ‰§è¡ŒD....æœ€åæ‰§è¡ŒZ

å†™å‡ºæ¥çš„ä»£ç å¯èƒ½æ˜¯è¿™æ ·çš„

```js
var sayhello = function (name, callback) {
  setTimeout(function () {
    console.log(name);
    callback();
  }, 1000);
}
sayhello("first", function () {
  sayhello("second", function () {
    sayhello("third", function () {
      console.log("end");
    });
  });
});
```

åƒæœ¬ä¾‹ä¸€æ ·åµŒå¥—å¤šä¸ªæ–¹æ³•è°ƒç”¨ä¼šåˆ›å»ºé”™ç»¼å¤æ‚çš„ä»£ç ï¼Œä¼šéš¾ä»¥ç†è§£ä¸è°ƒè¯•ã€‚å½“æƒ³è¦å®ç°æ›´å¤ æ‚çš„åŠŸèƒ½æ—¶ï¼Œå›è°ƒå‡½æ•°ä¹Ÿä¼šå­˜åœ¨é—®é¢˜:è‹¥æƒ³è®©ä¸¤ä¸ªå¼‚æ­¥æ“ä½œå¹¶è¡Œè¿è¡Œï¼Œå¹¶ä¸”åœ¨å®ƒä»¬éƒ½ç»“æŸå æé†’ä½ ï¼Œé‚£è¯¥æ€ä¹ˆåš?è‹¥æƒ³åŒæ—¶å¯åŠ¨ä¸¤ä¸ªå¼‚æ­¥æ“ä½œï¼Œä½†åªé‡‡ç”¨é¦–ä¸ªç»“æŸçš„ç»“æœï¼Œé‚£åˆè¯¥æ€ä¹ˆ åš?

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½ éœ€è¦è¿½è¸ªå¤šä¸ªå›è°ƒå‡½æ•°å¹¶åšæ¸…ç†æ“ä½œï¼Œ ä¸è¿‡å¥½åœ¨promiseæ¨ªç©ºå‡ºä¸–æ‹¯æ•‘äº†ä¸–ç•Œã€‚

### æ¶‰åŠé¢è¯•é¢˜

> promiseç”¨è¿‡å—ï¼Ÿè¯·ä½ ä»‹ç»ä¸€ä¸‹promiseã€‚

å…¶å®è¿™é‡Œå¾ˆå¤šåŒå­¦å¯èƒ½å°±ä¸çŸ¥é“æ€ä¹ˆä»‹ç»äº†ï¼Œå¯èƒ½åªåœç•™åœ¨æ€ä¹ˆç”¨ã€‚æˆ‘ä»¬å¯ä»¥ä»å‡ ä¸ªæ–¹é¢æ¥ä»‹ç»ã€‚

- promiseæ˜¯ä»€ä¹ˆï¼Ÿ
- promiseè§£å†³äº†ä»€ä¹ˆé—®é¢˜
- promiseçš„ä¼˜ç¼ºç‚¹

#### promiseæ˜¯ä»€ä¹ˆï¼Ÿ

æ‰€è°“`Promise`ï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢ä¿å­˜ç€æŸä¸ªæœªæ¥æ‰ä¼šç»“æŸçš„äº‹ä»¶ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼‰çš„ç»“æœã€‚ä»è¯­æ³•ä¸Šè¯´ï¼ŒPromise æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»å®ƒå¯ä»¥è·å–å¼‚æ­¥æ“ä½œçš„æ¶ˆæ¯ã€‚Promise æä¾›ç»Ÿä¸€çš„ APIï¼Œå„ç§å¼‚æ­¥æ“ä½œéƒ½å¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚

#### promiseè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

1. è§£å†³å¯è¯»æ€§çš„é—®é¢˜
2. è§£å†³ä¿¡ä»»é—®é¢˜

##### å¯è¯»æ€§

å¯è¯»æ€§ï¼Œä¹‹å‰çš„å›è°ƒåœ°ç‹±promiseå°±å¯ä»¥ä¼˜é›…çš„è§£å†³ã€‚(è¿˜æœ‰æ›´åŠ ä¼˜é›…çš„ï¼Œå¾…ä¼šä¼šä»‹ç»ã€‚)

```js
var sayhello = function (name) {
  return new Promise(function (resolve, reject) {
    setTimeout(function () {
      console.log(name);
      resolve();ã€€ã€€//åœ¨å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œåæ‰§è¡Œ resolve() å‡½æ•°
    }, 10000);
  });
}
sayhello("first").then(function () {
  return sayhello("second");ã€€ã€€//ä»ç„¶è¿”å›ä¸€ä¸ª Promise å¯¹è±¡
}).then(function () {
  return sayhello("third");
}).then(function () {
  console.log('end');
}).catch(function (err) {
  console.log(err);
})
```

##### ä¿¡ä»»é—®é¢˜

è¿™ä¸ªé—®é¢˜å¯ä»¥ç”¨promiseçš„å‡ ä¸ªç‰¹ç‚¹æ¥è§£é‡Šï¼š

> ï¼ˆ1ï¼‰å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“ã€‚`Promise`å¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼š`pending`ï¼ˆè¿›è¡Œä¸­ï¼‰ã€`fulfilled`ï¼ˆå·²æˆåŠŸï¼‰å’Œ`rejected`ï¼ˆå·²å¤±è´¥ï¼‰ã€‚åªæœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå¯ä»¥å†³å®šå½“å‰æ˜¯å“ªä¸€ç§çŠ¶æ€ï¼Œä»»ä½•å…¶ä»–æ“ä½œéƒ½æ— æ³•æ”¹å˜è¿™ä¸ªçŠ¶æ€ã€‚è¿™ä¹Ÿæ˜¯`Promise`è¿™ä¸ªåå­—çš„ç”±æ¥ï¼Œå®ƒçš„è‹±è¯­æ„æ€å°±æ˜¯â€œæ‰¿è¯ºâ€ï¼Œè¡¨ç¤ºå…¶ä»–æ‰‹æ®µæ— æ³•æ”¹å˜ã€‚
>
> ï¼ˆ2ï¼‰ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥å¾—åˆ°è¿™ä¸ªç»“æœã€‚`Promise`å¯¹è±¡çš„çŠ¶æ€æ”¹å˜ï¼Œåªæœ‰ä¸¤ç§å¯èƒ½ï¼šä»`pending`å˜ä¸º`fulfilled`å’Œä»`pending`å˜ä¸º`rejected`ã€‚åªè¦è¿™ä¸¤ç§æƒ…å†µå‘ç”Ÿï¼ŒçŠ¶æ€å°±å‡å›ºäº†ï¼Œä¸ä¼šå†å˜äº†ï¼Œä¼šä¸€ç›´ä¿æŒè¿™ä¸ªç»“æœï¼Œè¿™æ—¶å°±ç§°ä¸º resolvedï¼ˆå·²å®šå‹ï¼‰ã€‚å¦‚æœæ”¹å˜å·²ç»å‘ç”Ÿäº†ï¼Œä½ å†å¯¹`Promise`å¯¹è±¡æ·»åŠ å›è°ƒå‡½æ•°ï¼Œä¹Ÿä¼šç«‹å³å¾—åˆ°è¿™ä¸ªç»“æœã€‚è¿™ä¸äº‹ä»¶ï¼ˆEventï¼‰å®Œå…¨ä¸åŒï¼Œäº‹ä»¶çš„ç‰¹ç‚¹æ˜¯ï¼Œå¦‚æœä½ é”™è¿‡äº†å®ƒï¼Œå†å»ç›‘å¬ï¼Œæ˜¯å¾—ä¸åˆ°ç»“æœçš„ã€‚

ç”±äºPromiseåªèƒ½è¢«å†³è®®ä¸€æ¬¡ï¼Œä¸”å†³è®®ä¹‹åæ— æ³•æ”¹å˜ï¼Œæ‰€ä»¥ï¼Œå³ä¾¿æ˜¯å¤šæ¬¡å›è°ƒï¼Œä¹Ÿä¸ä¼šå½±å“ç»“æœï¼Œå†³è®®ä¹‹åçš„è°ƒç”¨éƒ½ä¼šè¢«å¿½ç•¥ã€‚

```js
//ä¿¡ä»»é—®é¢˜æ¼”ç¤º

//å›è°ƒ
function method(cb){
    setTimeout(function(){
        cb && cb();
        //å› ä¸ºæŸäº›bugå¯¼è‡´æŸä¸ªå‡½æ•°å¤šæ‰§è¡Œäº†ä¸€æ¬¡
        cb && cb();
    },1000);
}

//promise
function method2(){
    return new Promise(resolve=>{
        setTimeout(function(){
            resolve();
            //resolveæˆåŠŸè°ƒç”¨ä¸€æ¬¡ä¹‹åï¼Œåé¢çš„ä¸ä¼šå†æ‰§è¡Œ
            resolve();
        },1000);        
    })
}
```

æ§åˆ¶åè½¬ã€‚ä½“ç°åœ¨å¯¹äºå‡½æ•°çš„æŠŠæ§ï¼Œæ¯”å¦‚thisç­‰ã€‚

```js
//å›è°ƒ
function method(cb){
    setTimeout(function(){
        cb && cb.call({a:1,b:2});//æ‰§è¡Œå›è°ƒï¼Œä½†æ˜¯æ·»æ²¹åŠ é†‹
    },1000);
}

//promise
function method2(){
    return new Promise(resolve=>{
        setTimeout(function(){
            resolve();//è°ƒç”¨çš„resolveéƒ½æ˜¯è‡ªå·±å†™çš„ï¼Œæ”¹å–„äº†æ§åˆ¶åè½¬çš„é—®é¢˜
        },1000);        
    })
}
```

### æ‰‹æ’•A+è§„èŒƒçš„promise

> é¢è¯•é¢˜ï¼šä½ çŸ¥é“promiseçš„A+è§„èŒƒå—ï¼Ÿï¼ˆæœ¬äººåœ¨æµ©é²¸ç§‘æŠ€è¢«é—®åˆ°çš„ï¼Œå½“æ—¶ç­”çš„æ”¯æ”¯å¾å¾ã€‚ã€‚ã€‚ï¼‰

æˆ‘ä½•æ­¢æ˜¯çŸ¥é“ï¼Œæˆ‘ç”šè‡³å¯ä»¥æ‰‹å†™ä¸€ä¸ªç¬¦åˆA+è§„èŒƒçš„promiseï¼

A+è§„èŒƒå¿«é€Ÿå…¥å£ï¼Œ[ç‚¹æˆ‘](https://promisesaplus.com/)



```js
function MyPromise(executor) {
  // æŠ¥é”™thisçš„æŒ‡å‘ï¼Œåé¢å¯èƒ½ä¼šæœ‰å›è°ƒå‡½æ•°ï¼Œç„¶åä¼šéšå¼ä¸¢å¤±å•Šä¹‹ç±»çš„ã€‚
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  self.status = 'pending';
  // å­˜å‚¨æˆåŠŸçš„å€¼
  self.value = null;
  // å­˜å‚¨å¤±è´¥çš„å€¼
  self.reason = null;
  function resolve(value) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹æˆåŠŸçš„å€¼
      self.value = value
      self.status = 'fulfilled';
    }
  }
  function reject(reason) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹å¤±è´¥çš„å€¼
      self.reason = reason
      self.status = 'rejected';
    }
  }
  
  executor(resolve, reject);
}
```

promiseé‡Œé¢æœ€éš¾çš„å°±æ˜¯thenäº†ï¼Œæˆ‘ä»¬å¿…é¡»å°†è¿™ä¸ªæ–¹æ³•å†™åœ¨ä»–çš„åŸå‹é“¾ä¸Šé¢ï¼Œå¹¶ä¸”ä»–æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯æˆåŠŸçš„å›è°ƒï¼Œä¸€ä¸ªæ˜¯å¤±è´¥çš„å›è°ƒã€‚

åºŸè¯ä¸å¤šè¯´ï¼Œå¼€å†²ï¼

#### æ”¯æŒå¼‚æ­¥

åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åŠ ä¸¤ä¸ªå˜é‡ã€‚

```js
function MyPromise(executor) {
  // æŠ¥é”™thisçš„æŒ‡å‘ï¼Œåé¢å¯èƒ½ä¼šæœ‰å›è°ƒå‡½æ•°ï¼Œç„¶åä¼šéšå¼ä¸¢å¤±å•Šä¹‹ç±»çš„ã€‚
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  self.status = 'pending';
  // å­˜å‚¨æˆåŠŸçš„å€¼
  self.value = null;
  // å­˜å‚¨å¤±è´¥çš„å€¼
  self.reason = null;
  // å­˜å‚¨æˆåŠŸçš„å›è°ƒ
  self.onResolved = [];
  // å­˜å‚¨å¤±è´¥çš„å›è°ƒ
  self.onRejected = [];
  
  function resolve(value) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹æˆåŠŸçš„å€¼
      self.value = value
      self.status = 'fulfilled';
    }
  }
  
  function reject(reason) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹å¤±è´¥çš„å€¼
      self.reason = reason
      self.status = 'rejected';
    }
  }
  
  executor(resolve, reject);
}
```

é¢œå€¼é«˜åˆç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°ï¼Œæˆ‘å¤šåŠ äº†ä¸¤ä¸ªå˜é‡ã€‚

```js
// å­˜å‚¨æˆåŠŸçš„å›è°ƒ
self.onResolved = [];
// å­˜å‚¨å¤±è´¥çš„å›è°ƒ
self.onRejected = [];
```

è¿™ä¸¤ä¸ªå˜é‡å‘¢ï¼Œä¹Ÿéå¸¸å¥½ç†è§£ï¼Œå°±æ˜¯å­˜å‚¨å›è°ƒçš„ã€‚é‚£ä¹ˆæœ‰ä¸€ä¸ªéå¸¸éå¸¸é‡è¦çš„é—®é¢˜ï¼Œæˆ‘å†™çš„æ—¶å€™ä¹Ÿå›°æ‰°äº†å¥½ä¹…ï¼Œä¸ºä»€ä¹ˆä¸€å®šè¦æ˜¯ä¸€ä¸ªæ•°ç»„å‘¢ï¼Ÿæˆ‘å­˜å‚¨ä¸ºä¸€ä¸ªå‡½æ•°ä¸è¡Œå—ï¼Ÿåˆ°æ—¶å€™æ‰§è¡Œå°±è¡Œå•¦ã€‚ã€‚ã€‚

qsï¼Œå’Œæˆ‘æƒ³ä¸€æ ·çš„å¸…å“¥é“å¥³å¯èƒ½æ¯”è¾ƒå¤šã€‚è¿™é‡Œæˆ‘ç»Ÿä¸€å›å¤ï¼š

å‡å¦‚è¯´ã€‚ä»¥ä¸‹çš„æƒ…å†µå‡ºç°çš„è¯ï¼Œå’‹åŠã€‚

```js
var p = new Promise((resolve, reject)=>{
    setTimeout(()=>{
        resolve(4)
    }, 1000)
})
p.then((res)=>{
    //4 res
    console.log(res, 'res')
})
p.then((res1)=>{
    //4 res1
    console.log(res1, 'res1')
})
```

è¿™ç§æƒ…å†µå‡ºç°ï¼Œå¦‚æœæˆ‘ä»¬åªæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„`console.log(res, 'res')`è¿™è¾ˆå­éƒ½æ— æ³•é—®ä¸–ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè¢«åé—¨çš„`console.log(res1, 'res')`ç»™è¦†ç›–äº†å‘€ã€‚å¯¹ä¸å¯¹ï¼Œå¦‚æœè¯´è¿™ä¸ª`resolve`ä»–å»¶è¿Ÿæ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦åšçš„æ˜¯æŠŠ`then`å‡½æ•°ç»™ä¿å­˜ä¸‹æ¥ï¼Œç­‰åˆ°`resolve`è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œä¾æ¬¡æ‰§è¡Œæˆ‘ä»¬æ‰€æœ‰åˆ›å»ºçš„`then`é‡Œé¢çš„å›è°ƒå‡½æ•°ã€‚

å¬æ‡‚æŒå£°ï¼

æ²¡å¬æ‡‚çš„æ¥ç€å¾€ä¸‹çœ‹ï¼Œæˆ‘ä»¬æŠŠå‰©ä½™å·¥ä½œåšå®Œï¼Œç„¶åä¸¾ä¸€ä¸ªä¾‹å­ã€‚é©¬ä¸Šå°±èƒ½æ˜ç™½äº†ã€‚

åˆšåˆšè¯´åˆ°ï¼Œæˆ‘ä»¬è¡¥å……ä¸¤ä¸ªå˜é‡ï¼Œç„¶åå†™ä¸‹æˆ‘ä»¬çš„`then`å‡½æ•°ã€‚

```js
MyPromise.prototype.then = function(onFulfilled, onRejected){
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'fulfilled') {
    onFulfilled(self.value);
  }
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'rejected') {
    onRejected(self.reason);
  }
  // å¦‚æœæ˜¯pendingåº”è¯¥å­˜å‚¨å½“å‰çš„å›è°ƒå‡½æ•°
  if(self.status === 'pending') {
    self.onResolved.push(() => {onFulfilled(self.value)})
    self.onRejected.push(() => {onRejected(self.reason)})
  }
}
```

ç„¶åæˆ‘ä»¬è¿˜éœ€è¦åœ¨`resolve`æˆ–è€…`reject`çš„æ—¶å€™æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨èµ·æ¥çš„è¿™äº›å‡½æ•°ã€‚

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```js
function MyPromise(executor) {
  // æŠ¥é”™thisçš„æŒ‡å‘ï¼Œåé¢å¯èƒ½ä¼šæœ‰å›è°ƒå‡½æ•°ï¼Œç„¶åä¼šéšå¼ä¸¢å¤±å•Šä¹‹ç±»çš„ã€‚
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  self.status = 'pending';
  // å­˜å‚¨æˆåŠŸçš„å€¼
  self.value = null;
  // å­˜å‚¨å¤±è´¥çš„å€¼
  self.reason = null;
  // å­˜å‚¨æˆåŠŸçš„å›è°ƒ
  self.onResolved = [];
  // å­˜å‚¨å¤±è´¥çš„å›è°ƒ
  self.onRejected = [];
  
  function resolve(value) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹æˆåŠŸçš„å€¼
      self.value = value
      self.status = 'fulfilled';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onResolved.forEach(fn => fn())
    }
  }
  
  function reject(reason) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹å¤±è´¥çš„å€¼
      self.reason = reason
      self.status = 'rejected';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onRejected.forEach(fn => fn())
    }
  }
  
  executor(resolve, reject);
}

MyPromise.prototype.then = function(onFulfilled, onRejected){
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'fulfilled') {
    onFulfilled(self.value);
  }
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'rejected') {
    onRejected(self.reason);
  }
  // å¦‚æœæ˜¯pendingåº”è¯¥å­˜å‚¨å½“å‰çš„å›è°ƒå‡½æ•°
  if(self.status === 'pending') {
    self.onResolved.push(() => {onFulfilled(self.value)})
    self.onRejected.push(() => {onRejected(self.reason)})
  }
}
```

OKã€‚æˆ‘ä»¬å…ˆè¯•è¯•æˆ‘ä»¬è‡ªå·±å†™çš„promiseã€‚è·‘ä¸€ä¸‹demoå§ã€‚ä¸ºäº†ç»™æ‡’åŒå­¦ä¾¿æ·çš„è°ƒè¯•ï¼Œç›´æ¥CVä¸‹é¢å°±å¥½å•¦ã€‚

```js
function MyPromise(executor) {
  // æŠ¥é”™thisçš„æŒ‡å‘ï¼Œåé¢å¯èƒ½ä¼šæœ‰å›è°ƒå‡½æ•°ï¼Œç„¶åä¼šéšå¼ä¸¢å¤±å•Šä¹‹ç±»çš„ã€‚
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  self.status = 'pending';
  // å­˜å‚¨æˆåŠŸçš„å€¼
  self.value = null;
  // å­˜å‚¨å¤±è´¥çš„å€¼
  self.reason = null;
  // å­˜å‚¨æˆåŠŸçš„å›è°ƒ
  self.onResolved = [];
  // å­˜å‚¨å¤±è´¥çš„å›è°ƒ
  self.onRejected = [];
  
  function resolve(value) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹æˆåŠŸçš„å€¼
      self.value = value
      self.status = 'fulfilled';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onResolved.forEach(fn => fn())
    }
  }
  
  function reject(reason) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹å¤±è´¥çš„å€¼
      self.reason = reason
      self.status = 'rejected';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onRejected.forEach(fn => fn())
    }
  }

  executor(resolve, reject);
}

MyPromise.prototype.then = function(onFulfilled, onRejected){
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'fulfilled') {
    onFulfilled(self.value);
  }
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'rejected') {
    onRejected(self.reason);
  }
  // å¦‚æœæ˜¯pendingåº”è¯¥å­˜å‚¨å½“å‰çš„å›è°ƒå‡½æ•°
  if(self.status === 'pending') {
    self.onResolved.push(() => {
      onFulfilled(self.value)
    })
    self.onRejected.push(() => {
      onRejected(self.reason)
    })
  }
}

var p = new MyPromise((resolve, reject)=>{
  setTimeout(()=>{
    resolve(4)
  }, 1000)
})
p.then((res)=>{
  //4 res
  console.log(res, 'res')
})
p.then((res1)=>{
  //4 res1
  console.log(res1, 'res1')
})
```

å—¯~å¦‚æ„¿è¾“å‡ºäº†ï¼Œé‚£å›åˆ°åˆšåˆšçš„é—®é¢˜ã€‚æˆ‘ä»¬æŠŠå›è°ƒçš„åœ°æ–¹ä¸è¦ç”¨æ•°ç»„è€Œç”¨å‡½æ•°å‘¢ï¼Ÿä¸ç”¨åŒå­¦ä»¬æ‰“å­—äº†ï¼Œç›´æ¥CVğŸ‘‡çš„ä»£ç å°±å¥½äº†ã€‚

```js
function MyPromise(executor) {
  // æŠ¥é”™thisçš„æŒ‡å‘ï¼Œåé¢å¯èƒ½ä¼šæœ‰å›è°ƒå‡½æ•°ï¼Œç„¶åä¼šéšå¼ä¸¢å¤±å•Šä¹‹ç±»çš„ã€‚
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  self.status = 'pending';
  // å­˜å‚¨æˆåŠŸçš„å€¼
  self.value = null;
  // å­˜å‚¨å¤±è´¥çš„å€¼
  self.reason = null;
  // å­˜å‚¨æˆåŠŸçš„å›è°ƒ
  self.onResolved = [];
  // å­˜å‚¨å¤±è´¥çš„å›è°ƒ
  self.onRejected = [];
  
  function resolve(value) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹æˆåŠŸçš„å€¼
      self.value = value
      self.status = 'fulfilled';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onResolved.forEach(fn => fn())
    }
  }
  
  function reject(reason) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹å¤±è´¥çš„å€¼
      self.reason = reason
      self.status = 'rejected';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onRejected.forEach(fn => fn())
    }
  }

  executor(resolve, reject);
}

MyPromise.prototype.then = function(onFulfilled, onRejected){
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'fulfilled') {
    onFulfilled(self.value);
  }
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'rejected') {
    onRejected(self.reason);
  }
  // å¦‚æœæ˜¯pendingåº”è¯¥å­˜å‚¨å½“å‰çš„å›è°ƒå‡½æ•°
  if(self.status === 'pending') {
    self.onResolved.push(() => {
      onFulfilled(self.value)
    })
    self.onRejected.push(() => {
      onRejected(self.reason)
    })
  }
}

var p = new MyPromise((resolve, reject)=>{
  setTimeout(()=>{
    resolve(4)
  }, 1000)
})
p.then((res)=>{
  //4 res
  console.log(res, 'res')
})
p.then((res1)=>{
  //4 res1
  console.log(res1, 'res1')
})
```

æ˜¯ä¸æ˜¯åªæœ‰`console.log(res1, 'res1')`å•¦ï¼Ÿå› ä¸ºæ‰§è¡Œ`then`çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„resolveè¿˜æœ‰æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ª`then`çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»–ä»¬å­˜å‚¨èµ·æ¥ï¼Œç„¶åä¾æ¬¡è°ƒç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨åˆ°æ•°ç»„ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯åˆ«çš„æ–¹æ³•ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯æŠŠä»–ä»¬å­˜èµ·æ¥ï¼Œåœ¨éœ€è¦è°ƒç”¨çš„æ—¶å€™è°ƒç”¨ã€‚

æ˜¯ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Ÿï¼ï¼

å¬æ‡‚æŒå£°ï¼

è€Œä¸”A+ä¹Ÿè¦æ±‚äº†ã€‚

> `2.2.6:then` may be called multiple times on the same promise.
>
> ï¼ˆpromise çš„ `then` å¯ä»¥é“¾å¼è°ƒç”¨å¤šæ¬¡ï¼‰
>
> 2.2.6.1ï¼šIf/when `promise` is fulfilled, all respective `onFulfilled` callbacks must execute in the order of their originating calls to `then`.
>
> ï¼ˆå¦‚æœæˆ–å½“ promise è½¬æ€æ˜¯ fulfilled æ—¶ï¼Œæ‰€æœ‰çš„ onFulfilled å›è°ƒå›ä»¥ä»–ä»¬æ³¨å†Œæ—¶çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼‰
>
> 2.2.6.2ï¼šIf/when `promise` is rejected, all respective `onRejected` callbacks must execute in the order of their originating calls to `then`.
>
> ï¼ˆå¦‚æœæˆ–å½“ promise è½¬æ€æ˜¯ rejected æ—¶ï¼Œæ‰€æœ‰çš„ onRejected å›è°ƒå›ä»¥ä»–ä»¬æ³¨å†Œæ—¶çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼‰

æˆ‘ä»¬å¯¹promiseçš„ç†è§£æ›´è¿›ä¸€æ­¥äº†ã€‚è®°å¾—æŠŠä»£ç æ”¹å›å»ï¼Œç»§ç»­å¾€ä¸‹èµ°ã€‚

åˆšåˆšæˆ‘ä»¬çš„demoè¿˜ä¸å¤Ÿé²æ£’ï¼Œè€Œä¸”æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹éƒ½æ˜¯å®Œç¾æƒ…å†µä¸‹ã€‚

æ¥ä¸‹æ¥è¦å‰‘èµ°åé”‹äº†ã€‚

> A+:
>
> 2.2.1ï¼šBoth `onFulfilled` and `onRejected` are optional arguments:
>
> ï¼ˆonFulfilled å’Œ onRejected éƒ½æ˜¯å¯é€‰å‚æ•°ï¼šï¼‰
>
> 2.2.1.1 If `onFulfilled` is not a function, it must be ignored.
>
> ï¼ˆå¦‚æœ onFulfilled ä¸æ˜¯å‡½æ•°ï¼Œå®ƒä¼šè¢«å¿½ç•¥ï¼‰
>
> 2.2.1.2 If `onRejected` is not a function, it must be ignored.
>
> ï¼ˆå¦‚æœ onRejected ä¸æ˜¯å‡½æ•°ï¼Œå®ƒä¼šè¢«å¿½ç•¥ï¼‰
>
> 2.2.7.2: If either `onFulfilled` or `onRejected` throws an exception `e`, `promise2` must be rejected with `e` as the reason.
>
> ï¼ˆå¦‚æœ onFulfilled æˆ– onRejected é‡ŒæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆ promise2 å¿…é¡»æ•è·è¿™ä¸ªé”™è¯¯ï¼ˆæ¥å—ä¸€ä¸ª reason å‚æ•°ï¼‰ï¼‰

æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦åšçš„å°±æ˜¯ï¼ŒæŠŠé”™è¯¯ç»™æå‰æ•è·ï¼Œç„¶åä¸¢ç»™`reject`

emmm....æ¥ä¸‹æˆ‘è´´ä»£ç éƒ½æ˜¯ä¸€èµ·è´´äº†ï¼Œå› ä¸ºæˆ‘æ€•æœ‰åŒå­¦ä¼šæ‰é˜Ÿï¼Œé‡Œé¢ä¹Ÿä¼šæœ‰ç›¸åº”çš„æ³¨é‡Šå¸®åŠ©ä¼šèµ°ç¥çš„åŒå­¦è·Ÿç´§è¿™è¾†äº”è±å®å…‰ã€‚

```js
function MyPromise(executor) {
  // æŠ¥é”™thisçš„æŒ‡å‘ï¼Œåé¢å¯èƒ½ä¼šæœ‰å›è°ƒå‡½æ•°ï¼Œç„¶åä¼šéšå¼ä¸¢å¤±å•Šä¹‹ç±»çš„ã€‚
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  self.status = 'pending';
  // å­˜å‚¨æˆåŠŸçš„å€¼
  self.value = null;
  // å­˜å‚¨å¤±è´¥çš„å€¼
  self.reason = null;
  // å­˜å‚¨æˆåŠŸçš„å›è°ƒ
  self.onResolved = [];
  // å­˜å‚¨å¤±è´¥çš„å›è°ƒ
  self.onRejected = [];
  
  function resolve(value) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹æˆåŠŸçš„å€¼
      self.value = value
      self.status = 'fulfilled';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onResolved.forEach(fn => fn())
    }
  }
  
  function reject(reason) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹å¤±è´¥çš„å€¼
      self.reason = reason
      self.status = 'rejected';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onRejected.forEach(fn => fn())
    }
  }
  // æ•è·é”™è¯¯ä¼ ç»™rejectã€‚æ³•å¾‹è§„å®šï¼
	try{
  	executor(resolve, reject);
  } catch(e) {
    reject(e);
  }
}

MyPromise.prototype.then = function(onFulfilled, onRejected){
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  // å¦‚æœä¸æ˜¯å‡½æ•°å°±å¿½ç•¥ 2.2.1.1
  if(self.status === 'fulfilled') {
    typeof onFulfilled === 'function' && onFulfilled(self.value);
  }
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  if(self.status === 'rejected') {
    typeof onFulfilled === 'function' && onRejected(self.reason);
  }
  // å¦‚æœæ˜¯pendingåº”è¯¥å­˜å‚¨å½“å‰çš„å›è°ƒå‡½æ•°
  // å¦‚æœä¸æ˜¯å‡½æ•°å°±å¿½ç•¥ 2.2.1.2
  if(self.status === 'pending') {
    // å¦‚æœä¸æ˜¯å‡½æ•°å°±å¿½ç•¥ 2.2.1.1
    typeof onFulfilled === 'function' && self.onResolved.push(() => {
      onFulfilled(self.value)
    })
    // å¦‚æœä¸æ˜¯å‡½æ•°å°±å¿½ç•¥ 2.2.1.2
    typeof onFulfilled === 'function' && self.onRejected.push(() => {
      onRejected(self.reason)
    })
  }
}
```

#### é“¾å¼è°ƒç”¨then

å¼€å§‹å‡†å¤‡è¿›å…¥promiseçš„éš¾ç‚¹ä»¥åŠæ ¸å¿ƒç‚¹ï¼šé“¾å¼è°ƒç”¨ã€‚

> 2.2.7ï¼š`then` must return a promise
>
> ï¼ˆthen æ–¹æ³•ä¸€å®šè¿”å›ä¸€ä¸ª promiseï¼‰

æˆ‘ä»¬éœ€è¦è¿”å›æ–°çš„promiseçš„è¯ï¼Œå¯ä»¥ç®€å•å®ç°ï¼Œå¿«é€Ÿè¿­ä»£ã€‚

```js
Promise.prototype.then = function (onFulfilled, onRejected) {
    let promise2 = new Promise((resolve, reject)=>{
    })
    return promise2
}
```

> 2.2.7.1ï¼šIf either `onFulfilled` or `onRejected` returns a value `x`, run the Promise Resolution Procedure `[[Resolve]](promise2, x)`.
>
> ï¼ˆå¦‚æœ onFulfilled æˆ– onRejected è¿”å›çš„æ˜¯ä¸€ä¸ª xï¼Œé‚£ä¹ˆå®ƒä¼šä»¥[[Resolve]](promise2, x)` å¤„ç†è§£æï¼‰
>
> 2.2.7.2ï¼šIf either `onFulfilled` or `onRejected` throws an exception `e`, `promise2` must be rejected with `e` as the reason.
>
> ï¼ˆå¦‚æœ onFulfilled æˆ– onRejected é‡ŒæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆ promise2 å¿…é¡»æ•è·è¿™ä¸ªé”™è¯¯ï¼ˆæ¥å—ä¸€ä¸ª reason å‚æ•°ï¼‰ï¼‰
>
> 2.2.7.3ï¼šIf `onFulfilled` is not a function and `promise1` is fulfilled, `promise2` must be fulfilled with the same value as `promise1`.
>
> ï¼ˆå¦‚æœ onFulfilled ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸” promise1 çŠ¶æ€æ˜¯ fulfilledï¼Œé‚£ä¹ˆ promise2 ä¸€å®šä¼šæ¥å—åˆ°ä¸ promse1 ä¸€æ ·çš„å€¼ valueï¼‰
>
> 2.2.7.4ï¼šIf `onRejected` is not a function and `promise1` is rejected, `promise2` must be rejected with the same reason as `promise1`.
>
> ï¼ˆå¦‚æœ onRejected ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸” promise1 çŠ¶æ€æ˜¯ rejectedï¼Œpromise2 ä¸€å®šä¼šæ¥å—åˆ°ä¸ promise1 ä¸€æ ·çš„å€¼ reasonï¼‰

æˆ‘ä»¬éœ€è¦å°†è¿”å›å†…å®¹promiseåŒ–ï¼Œéœ€è¦å¯¹onFulfilledå’ŒonRejectedè¿›è¡Œé”™è¯¯å¤„ç†ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰å°±å¤„ç†è¿‡äº†ï¼Œå¦‚æœonFulfilledå’ŒonRejectedæ²¡æœ‰ä¼ å‚å°±ç»§ç»­ä¼ é€’ï¼ŒåŸç”ŸğŸŒ°æ¥ï¼š

```js
var p = new Promise(function(resolve, reject){
    setTimeout(function(){
        resolve(3)
    }, 1000)
});
p.then(1,1)
.then('','')
.then()
.then(function(res){
    //3
    console.log(res)
})
```

è¿™é‡Œä¸ç®¡onFulfilledå’ŒonRejectedä¼ ä»€ä¹ˆå€¼ï¼Œåªè¦ä¸æ˜¯å‡½æ•°ï¼Œå°±ç»§ç»­å‘ä¸‹ä¼ å…¥ï¼Œç›´åˆ°æœ‰å‡½æ•°è¿›è¡Œæ¥æ”¶ï¼›è¦åšçš„äº‹æƒ…å¤ªå¤šäº†ï¼Œä¸å½“å½“æ˜¯åˆ¤æ–­å‡½æ•°è¿™ç§ç®€å•çš„åˆ¤æ–­äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠ½ç¦»ä¸€ä¸ªæ–°çš„å‡½æ•°æ¥å¤ç”¨ç»Ÿä¸€å¤„ç†ã€‚å› æ­¤æˆ‘ä»¬è¿›è¡Œå¦‚ä¸‹å®Œå–„ï¼š

```js
function MyPromise(executor) {
  // æŠ¥é”™thisçš„æŒ‡å‘ï¼Œåé¢å¯èƒ½ä¼šæœ‰å›è°ƒå‡½æ•°ï¼Œç„¶åä¼šéšå¼ä¸¢å¤±å•Šä¹‹ç±»çš„ã€‚
  let self = this;
  // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
  self.status = 'pending';
  // å­˜å‚¨æˆåŠŸçš„å€¼
  self.value = null;
  // å­˜å‚¨å¤±è´¥çš„å€¼
  self.reason = null;
  // å­˜å‚¨æˆåŠŸçš„å›è°ƒ
  self.onResolved = [];
  // å­˜å‚¨å¤±è´¥çš„å›è°ƒ
  self.onRejected = [];
  
  function resolve(value) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹æˆåŠŸçš„å€¼
      self.value = value
      self.status = 'fulfilled';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onResolved.forEach(fn => fn())
    }
  }
  
  function reject(reason) {
    // 2.1.1è§„å®šåªæœ‰åœ¨pendingçŠ¶æ€çš„æ—¶å€™æ‰å¯ä»¥è½¬å˜
    if(self.status === 'pending') {
      // å­˜ä¸‹å¤±è´¥çš„å€¼
      self.reason = reason
      self.status = 'rejected';
      // æ‰§è¡Œæˆ‘ä»¬å­˜å‚¨çš„å‡½æ•°;
      self.onRejected.forEach(fn => fn())
    }
  }
  // æ•è·é”™è¯¯ä¼ ç»™rejectã€‚æ³•å¾‹è§„å®šï¼
	try{
  	executor(resolve, reject);
  } catch(e) {
    reject(e);
  }
}

function resolvePromise(promise2, res, resolve, reject) {
  // å¦‚æœpromise2å’Œç»“æœç›¸åŒï¼Œå°±è‡ªå·±æ— é™å¾ªç¯è°ƒç”¨è‡ªå·±çš„thenäº†ï¼Œæ­»äº¡å¾ªç¯ã€‚
  // ä¸¾ä¸ªğŸŒ°ï¼švar a = function(){return a}ï¼Œè¿™ä¸ªthenåˆä¼šè‡ªå·±æ— é™è§¦å‘ã€‚æ‰€ä»¥å°±ç©å®Œäº†ã€‚
  if(promise2 === res) {
    return reject(new TypeError('å¾ªç¯å¼•ç”¨'))
  }
  if(
    res !== null 
    && (typeof res === 'object') || typeof res === 'function')
  ) {
    try {
      // ä¿å­˜æ˜¯å¦å·²ç»è°ƒç”¨è¿‡å‡½æ•°ã€‚
      // 2.3.3.3.3 If both resolvePromise and rejectPromise are called, or multiple calls to the same argument are made, the first call takes precedence, and any further calls are ignored.(å¦‚æœ resolvePromise å’Œ rejectPromise å·²ç»è¢«è°ƒç”¨æˆ–ä»¥ç›¸åŒçš„å‚æ•°å¤šæ¬¡è°ƒç”¨çš„è¯å—ï¼Œä¼˜å…ˆç¬¬ä¸€æ¬¡çš„è°ƒç”¨ï¼Œå¹¶ä¸”ä¹‹åçš„è°ƒç”¨å…¨éƒ¨è¢«å¿½ç•¥ï¼ˆé¿å…å¤šæ¬¡è°ƒç”¨ï¼‰)
      let used = false;
      
      // 2.3.3.1ï¼šLet then be x.then. [3.5](æŠŠ x.then èµ‹å€¼ç»™ then å˜é‡)
      // å¯ä»¥æé˜²æœ‰äººæ¶æã€‚åƒğŸ‘‡
      // Object.defineProperty(Promise, 'then', {
      //    get: function(){
      //        throw Error('error')
      //    }
      // })
      // è¿™æ ·çš„è¯æˆ‘ä»¬å–å€¼å°±ä¼šæŠ¥é”™ã€‚
      let then = res.then;
      // å¦‚æœthenæ˜¯å‡½æ•°ï¼Œå°±é»˜è®¤æ˜¯promiseäº†   
      if(typeof then === 'function') {
        then.call(
          res, 
          value => {
            if(used) {
              return;
            }
            used = true;
            // é€’å½’è§£æï¼Œç›´åˆ°ä¸æ˜¯ä¸€ä¸ªpromiseä¸ºæ­¢
            resolvePromise(promise2, value, resolve, reject);
        	},
          reason => {
            if(used) {
              return;
            }
            used = true;
            reject(reason);
          }
        )
      }
    } catch (e) {
      if(used) {
        return;
      }
      used = true;
      reject(e);
    }
  } else {
    // å¦‚æœä¸æ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡ä¹Ÿä¸ä¸ºç©ºå°±ç›´æ¥ç»§ç»­ä¼ é€’è¿™ä¸ªå€¼ã€‚
	  resolve(res);  
  }
}

MyPromise.prototype.then = function(onFulfilled, onRejected){
  let self = this;
  // åªæœ‰promiseæ‰å¯ä»¥æŒç»­çš„é“¾å¼è°ƒç”¨then,æ‰€ä»¥è¿™é‡Œå¼„äº†ä¸€ä¸ªæ–°çš„promise
  let promise2 = new MyPromise((resolve, reject) => {
    // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
    if(self.status === 'fulfilled') {
      let res = onFulfilled(self.value);
      resolvePromise(promise2, res, resolve, reject);
    }
    // å½“å‰çš„çŠ¶æ€ï¼ˆfulfilled/rejected/pendingï¼‰ï¼Œé»˜è®¤å€¼ä¸ºpending
    if(self.status === 'rejected') {
      let res = onRejected(self.reason);
      resolvePromise(promise2, res, resolve, reject);
    }
    // å¦‚æœæ˜¯pendingåº”è¯¥å­˜å‚¨å½“å‰çš„å›è°ƒå‡½æ•°
    if(self.status === 'pending') {
      self.onResolved.push(() => {
        let res = onFulfilled(self.value);
      resolvePromise(promise2, res, resolve, reject);
      })
      self.onRejected.push(() => {
        let res = onRejected(self.reason);
      resolvePromise(promise2, res, resolve, reject);
      })
    }
  })
}
```

ä»¥ä¸Šå°±æ˜¯ç¬¦åˆ Promise/A+ è§„èŒƒçš„å®ç°äº†ï¼Œå¦‚æœä½ å¯¹äºè¿™éƒ¨åˆ†ä»£ç å°šæœ‰ç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºä¸­ä¸æˆ‘äº’åŠ¨ã€‚

## Generator

## async/await























