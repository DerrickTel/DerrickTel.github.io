<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>【重识前端】React-Router源码阅读 | Derrick</title><meta name="description" content="【重识前端】React-Router源码阅读"><meta name="keywords" content="React,源码阅读"><meta name="author" content="Derrick"><meta name="copyright" content="Derrick"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="【重识前端】React-Router源码阅读"><meta name="twitter:description" content="【重识前端】React-Router源码阅读"><meta name="twitter:image" content="http://derricktel.github.io/image/cover/web.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="【重识前端】React-Router源码阅读"><meta property="og:url" content="http://derricktel.github.io/2020/11/14/%E3%80%90%E9%87%8D%E8%AF%86%E5%89%8D%E7%AB%AF%E3%80%91React-Router%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><meta property="og:site_name" content="Derrick"><meta property="og:description" content="【重识前端】React-Router源码阅读"><meta property="og:image" content="http://derricktel.github.io/image/cover/web.jpeg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://derricktel.github.io/2020/11/14/%E3%80%90%E9%87%8D%E8%AF%86%E5%89%8D%E7%AB%AF%E3%80%91React-Router%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><link rel="prev" title="「如何给开源库提一个PR」" href="http://derricktel.github.io/2021/01/22/%E3%80%8C%E5%A6%82%E4%BD%95%E7%BB%99github%E6%8F%90%E4%B8%80%E4%B8%AAPR%E3%80%8D/"><link rel="next" title="【面经】2年前端杭州面试集合" href="http://derricktel.github.io/2020/10/28/%E3%80%90%E9%9D%A2%E7%BB%8F%E3%80%912%E5%B9%B4%E5%89%8D%E7%AB%AF%E6%9D%AD%E5%B7%9E%E9%9D%A2%E8%AF%95%E9%9B%86%E5%90%88/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">38</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">43</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">19</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-about"></i><span> 关于我</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#学前小知识"><span class="toc-number">2.</span> <span class="toc-text">学前小知识</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#简单示例"><span class="toc-number">3.</span> <span class="toc-text">简单示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#react-router和react-router-dom的区别。"><span class="toc-number">3.1.</span> <span class="toc-text">react-router和react-router-dom的区别。</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#先看提供的API"><span class="toc-number">3.1.1.</span> <span class="toc-text">先看提供的API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#React-router"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">React-router</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#React-router-dom"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">React-router-dom</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单修改"><span class="toc-number">3.2.</span> <span class="toc-text">简单修改</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SPA的核心思想"><span class="toc-number">4.</span> <span class="toc-text">SPA的核心思想</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#源码攻读"><span class="toc-number">5.</span> <span class="toc-text">源码攻读</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BrowserRouter"><span class="toc-number">5.1.</span> <span class="toc-text">BrowserRouter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-router"><span class="toc-number">5.2.</span> <span class="toc-text">react-router</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构造函数"><span class="toc-number">5.2.1.</span> <span class="toc-text">构造函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#componentWillUnmount"><span class="toc-number">5.2.2.</span> <span class="toc-text">componentWillUnmount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#componentDidUnmount"><span class="toc-number">5.2.3.</span> <span class="toc-text">componentDidUnmount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#render"><span class="toc-number">5.2.4.</span> <span class="toc-text">render</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">5.2.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#history"><span class="toc-number">5.3.</span> <span class="toc-text">history</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#createBrowserHistory"><span class="toc-number">5.3.1.</span> <span class="toc-text">createBrowserHistory</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#返回的内容"><span class="toc-number">5.3.1.1.</span> <span class="toc-text">返回的内容</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#go"><span class="toc-number">5.3.1.1.1.</span> <span class="toc-text">go</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createHref"><span class="toc-number">5.3.1.1.2.</span> <span class="toc-text">createHref</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#push"><span class="toc-number">5.3.1.1.3.</span> <span class="toc-text">push</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#replace"><span class="toc-number">5.3.1.1.4.</span> <span class="toc-text">replace</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#listen"><span class="toc-number">5.3.1.1.5.</span> <span class="toc-text">listen</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#createEvents"><span class="toc-number">5.3.1.1.6.</span> <span class="toc-text">createEvents</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#block"><span class="toc-number">5.3.1.1.7.</span> <span class="toc-text">block</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#总结-1"><span class="toc-number">5.3.1.1.8.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#具体核心原理"><span class="toc-number">5.3.1.2.</span> <span class="toc-text">具体核心原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createHashHistory"><span class="toc-number">5.3.2.</span> <span class="toc-text">createHashHistory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scrollIntoView"><span class="toc-number">5.3.3.</span> <span class="toc-text">scrollIntoView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#scrollTop"><span class="toc-number">5.3.4.</span> <span class="toc-text">scrollTop</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-anchor-without-hash"><span class="toc-number">5.4.</span> <span class="toc-text">react-anchor-without-hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#具体核心原理-1"><span class="toc-number">5.4.0.1.</span> <span class="toc-text">具体核心原理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#核心API"><span class="toc-number">6.</span> <span class="toc-text">核心API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Switch"><span class="toc-number">6.1.</span> <span class="toc-text">Switch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#摘自官网"><span class="toc-number">6.2.</span> <span class="toc-text">摘自官网</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#location-object"><span class="toc-number">6.3.</span> <span class="toc-text">location: object</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#matchPath"><span class="toc-number">6.3.1.</span> <span class="toc-text">matchPath</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Route"><span class="toc-number">6.4.</span> <span class="toc-text">Route</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#component"><span class="toc-number">6.4.1.</span> <span class="toc-text">component</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#children"><span class="toc-number">6.4.2.</span> <span class="toc-text">children</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#render-1"><span class="toc-number">6.4.3.</span> <span class="toc-text">render</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exact-amp-strict-amp-sensitive"><span class="toc-number">6.4.4.</span> <span class="toc-text">exact &amp; strict &amp; sensitive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#location"><span class="toc-number">6.4.5.</span> <span class="toc-text">location</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prompt"><span class="toc-number">6.5.</span> <span class="toc-text">Prompt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redirect"><span class="toc-number">6.6.</span> <span class="toc-text">Redirect</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结-2"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#流程"><span class="toc-number">7.1.</span> <span class="toc-text">流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修改url"><span class="toc-number">7.1.1.</span> <span class="toc-text">修改url</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/image/cover/web.jpeg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Derrick</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-about"></i><span> 关于我</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">【重识前端】React-Router源码阅读</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-11-14 20:29:17"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-11-14</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-06-29 11:10:08"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-06-29</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E9%87%8D%E6%8B%BE%E5%89%8D%E7%AB%AF/">重拾前端</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>此处介绍一下React-Router的核心原理。特别细致的标点符号的不予讨论。</p>
<h1 id="学前小知识"><a href="#学前小知识" class="headerlink" title="学前小知识"></a>学前小知识</h1><p><code>React-Router</code>其实最核心的东西是<code>Route</code>组件和由统一作者开发的<code>History</code>库来建立的。接下来跟着镜头一起走进神秘的<code>ßReact-Router</code>世界吧。</p>
<p>已经知道怎么使用的直接跳过，到下面的源码分析去┗|｀O′|┛ 嗷~~</p>
<h1 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h1><p>一起建一个简单的示例吧。先用<code>react</code>官网的<code>create-react-app</code>脚手架弄个<code>react</code>出来。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app my-app</span><br><span class="line"><span class="built_in">cd</span> my-app</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>

<p>安装<a href="https://reactrouter.com/web/guides/quick-start" target="_blank" rel="noopener">react-router-dom</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install react-router-dom</span><br></pre></td></tr></table></figure>

<p>在大家安装之余，我简答的介绍一下<code>react-router</code>和<code>react-router-dom</code>的区别。</p>
<h2 id="react-router和react-router-dom的区别。"><a href="#react-router和react-router-dom的区别。" class="headerlink" title="react-router和react-router-dom的区别。"></a>react-router和react-router-dom的区别。</h2><h3 id="先看提供的API"><a href="#先看提供的API" class="headerlink" title="先看提供的API"></a>先看提供的API</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Switch, Route, Router &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Swtich, Route, BrowserRouter, HashHistory, Link &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="React-router"><a href="#React-router" class="headerlink" title="React-router"></a>React-router</h4><p>提供了路由的核心api。如Router、Route、Switch等，但没有提供有关dom操作进行路由跳转的api；</p>
<h4 id="React-router-dom"><a href="#React-router-dom" class="headerlink" title="React-router-dom"></a>React-router-dom</h4><p>提供了<code>BrowserRouter</code>、<code>Route</code>、<code>Link</code>等api，可以通过dom操作触发事件控制路由。</p>
<p><code>Link</code>组件，会渲染一个a标签；<code>BrowserRouter</code>和<code>HashRouter</code>组件，前者使用<code>pushState</code>和<code>popState</code>事件构建路由，后者使用<code>hash</code>和 <code>hashchange</code>事件构建路由。</p>
<p><code>react-router-dom</code>在<code>react-router</code>的基础上扩展了可操作<code>dom</code>的<code>api</code>。</p>
<p><code>Swtich</code> 和 <code>Route</code> 都是从<code>react-router</code>中导入了相应的组件并重新导出，没做什么特殊处理。</p>
<p><code>react-router-dom</code>中<code>package.json</code>依赖中存在对<code>react-router</code>的依赖，故此，不需要<code>npm</code>安装<code>react-router</code>。</p>
<blockquote>
<ul>
<li>可直接 npm 安装 react-router-dom，使用其api。</li>
</ul>
</blockquote>
<h2 id="简单修改"><a href="#简单修改" class="headerlink" title="简单修改"></a>简单修改</h2><p>👌，大家🔥应该已经安装完了吧？接下来简单的修改一下脚手架里面的内容。主要是为了熟悉对手，知己知彼百战百胜。</p>
<p><img src="/" class="lazyload" data-src="/image/router/demo.gif"  alt="demo"></p>
<p>修改一下<code>src/app.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  BrowserRouter <span class="keyword">as</span> Router,</span><br><span class="line">  Switch,</span><br><span class="line">  Route,</span><br><span class="line">  Link,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">"react-router-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Home</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;首页&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Link to="/</span>login<span class="string">"&gt;登录&lt;/Link&gt;</span></span><br><span class="line"><span class="string">    &lt;/&gt;</span></span><br><span class="line"><span class="string">  )</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function Login() &#123;</span></span><br><span class="line"><span class="string">  return (</span></span><br><span class="line"><span class="string">    &lt;&gt;</span></span><br><span class="line"><span class="string">      &lt;h1&gt;登录页&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;Link to="</span>/<span class="string">"&gt;回首页&lt;/Link&gt;</span></span><br><span class="line"><span class="string">    &lt;/&gt;</span></span><br><span class="line"><span class="string">  );</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function App() &#123;</span></span><br><span class="line"><span class="string">  return (</span></span><br><span class="line"><span class="string">    &lt;Router&gt;</span></span><br><span class="line"><span class="string">      &lt;Switch&gt;</span></span><br><span class="line"><span class="string">        &lt;Route path="</span>/login<span class="string">" component=&#123;Login&#125;/&gt;</span></span><br><span class="line"><span class="string">        &lt;Route path="</span>/<span class="string">" component=&#123;Home&#125;/&gt;</span></span><br><span class="line"><span class="string">      &lt;/Switch&gt;</span></span><br><span class="line"><span class="string">    &lt;/Router&gt;</span></span><br><span class="line"><span class="string">  );</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default App;</span></span><br></pre></td></tr></table></figure>

<p>这样就完成了一个最简单的示例了。</p>
<h1 id="SPA的核心思想"><a href="#SPA的核心思想" class="headerlink" title="SPA的核心思想"></a>SPA的核心思想</h1><ul>
<li>监听<code>URL</code>的变化</li>
<li>改变某些<code>context</code>的值</li>
<li>获取对应的页面组件</li>
<li><code>render</code>新的页面</li>
</ul>
<h1 id="源码攻读"><a href="#源码攻读" class="headerlink" title="源码攻读"></a>源码攻读</h1><h2 id="BrowserRouter"><a href="#BrowserRouter" class="headerlink" title="BrowserRouter"></a>BrowserRouter</h2><p>从前面的简单示例中我们，发现有一个最外层的伙计，叫<code>BrowserRouter</code>。我们直接干到他的github源码去瞅瞅。</p>
<p>链接：<a href="https://github.com/ReactTraining/react-router/blob/master/packages/react-router-dom/modules/BrowserRouter.js" target="_blank" rel="noopener">https://github.com/ReactTraining/react-router/blob/master/packages/react-router-dom/modules/BrowserRouter.js</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">"react-router"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createBrowserHistory <span class="keyword">as</span> createHistory &#125; <span class="keyword">from</span> <span class="string">"history"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> warning <span class="keyword">from</span> <span class="string">"tiny-warning"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The public API for a &lt;Router&gt; that uses HTML5 history.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BrowserRouter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  history = createHistory(<span class="keyword">this</span>.props);</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Router</span> <span class="attr">history</span>=<span class="string">&#123;this.history&#125;</span> <span class="attr">children</span>=<span class="string">&#123;this.props.children&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">  BrowserRouter.propTypes = &#123;</span><br><span class="line">    basename: PropTypes.string,</span><br><span class="line">    children: PropTypes.node,</span><br><span class="line">    forceRefresh: PropTypes.bool,</span><br><span class="line">    getUserConfirmation: PropTypes.func,</span><br><span class="line">    keyLength: PropTypes.number</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  BrowserRouter.prototype.componentDidMount = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    warning(</span><br><span class="line">      !<span class="keyword">this</span>.props.history,</span><br><span class="line">      <span class="string">"&lt;BrowserRouter&gt; ignores the history prop. To use a custom history, "</span> +</span><br><span class="line">        <span class="string">"use `import &#123; Router &#125;` instead of `import &#123; BrowserRouter as Router &#125;`."</span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> BrowserRouter;</span><br></pre></td></tr></table></figure>

<p>抛开一些七七八八的判断。重新看。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">"react-router"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createBrowserHistory <span class="keyword">as</span> createHistory &#125; <span class="keyword">from</span> <span class="string">"history"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BrowserRouter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  history = createHistory(<span class="keyword">this</span>.props);</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Router</span> <span class="attr">history</span>=<span class="string">&#123;this.history&#125;</span> <span class="attr">children</span>=<span class="string">&#123;this.props.children&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写着几个大字：《瓜子二手车》他只是一个中间商，他在赚差价。（打钱！</p>
<p><code>BrowserRouter</code>是依赖于两个库：分别为<code>history</code>和<code>react-router</code>。ok，我们一探究竟。</p>
<h2 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h2><p>源码链接：<a href="https://github.com/ReactTraining/react-router/blob/master/packages/react-router/modules/Router.js" target="_blank" rel="noopener">https://github.com/ReactTraining/react-router/blob/master/packages/react-router/modules/Router.js</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> HistoryContext <span class="keyword">from</span> <span class="string">"./HistoryContext.js"</span>;</span><br><span class="line"><span class="keyword">import</span> RouterContext <span class="keyword">from</span> <span class="string">"./RouterContext.js"</span>;</span><br></pre></td></tr></table></figure>

<p>这两个东西其实很简单，都是引用了一个叫做<code>createContext</code>，目的也很简单，这里其实就是创建的普通context，只不过拥有特定的名称而已。源码如下。就几行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Replace with React.createContext once we can assume React 16+</span></span><br><span class="line"><span class="keyword">import</span> createContext <span class="keyword">from</span> <span class="string">"mini-create-react-context"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createNamedContext = <span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> context = createContext();</span><br><span class="line">  context.displayName = name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createNamedContext;</span><br></pre></td></tr></table></figure>

<p>OK，重点是接下来，抛开context之后，我们需要关注的东西。我整理一下。</p>
<p>先看构造函数</p>
<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">  <span class="keyword">super</span>(props);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.state = &#123;</span><br><span class="line">    location: props.history.location</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is a bit of a hack. We have to start listening for location</span></span><br><span class="line">  <span class="comment">// changes here in the constructor in case there are any &lt;Redirect&gt;s</span></span><br><span class="line">  <span class="comment">// on the initial render. If there are, they will replace/push when</span></span><br><span class="line">  <span class="comment">// they mount and since cDM fires in children before parents, we may</span></span><br><span class="line">  <span class="comment">// get a new location before the &lt;Router&gt; is mounted.</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// _isMounted 表示组件是否加载完成</span></span><br><span class="line">  <span class="keyword">this</span>._isMounted = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// 组件未加载完毕，但是 location 发生的变化，暂存在 _pendingLocation 字段中</span></span><br><span class="line">  <span class="keyword">this</span>._pendingLocation = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 没有 staticContext 属性，表示是 HashRouter 或是 BrowserRouter</span></span><br><span class="line">  <span class="keyword">if</span> (!props.staticContext) &#123;</span><br><span class="line">    <span class="keyword">this</span>.unlisten = props.history.listen(<span class="function"><span class="params">location</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>._isMounted) &#123;</span><br><span class="line">        <span class="comment">// 组件加载完毕，将变化的 location 方法 state 中</span></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; location &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>._pendingLocation = location;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有两个值☞<code>_isMounted</code>和<code>_pendingLocation</code></p>
<p>分别是  是否挂载   待定</p>
<p>内部维护了一个location，默认值是由外面传入的history，我找到传入的地方。</p>
<p>其实就是之前看到的<code>BrowserRouter</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router &#125; <span class="keyword">from</span> <span class="string">"react-router"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createBrowserHistory <span class="keyword">as</span> createHistory &#125; <span class="keyword">from</span> <span class="string">"history"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BrowserRouter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  history = createHistory(<span class="keyword">this</span>.props);</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Router</span> <span class="attr">history</span>=<span class="string">&#123;this.history&#125;</span> <span class="attr">children</span>=<span class="string">&#123;this.props.children&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难发现，history的默认值就是由history这个库来提供的，这个后面会提到，我们继续看。</p>
<p>先简单看一下注释的翻译(谷歌翻译)</p>
<blockquote>
<p>这有点hack。 我们必须开始在构造函数中监听位置更改，以防初始渲染中存在任何<Redirect>。 如果有的话，它们将在安装时替换/推动，并且由于cDM在父级之前在子级中触发，因此在安装<Router>之前，我们可能会获得一个新位置。 </p>
</blockquote>
<p>什么意思呢，我简单描述一下：</p>
<blockquote>
<p>因为子组件会比父组件更早渲染完成, 以及<code>&lt;Redirect&gt;</code>的存在, 若是在<code>&lt;Router&gt;</code>的<code>componentDidMount</code>生命周期中对<code>history.location</code>进行监听, 则有可能在监听事件注册之前, <code>history.location</code>已经由于<code>&lt;Redirect&gt;</code>发生了多次改变, 因此我们需要在<code>&lt;Router&gt;</code>的<code>constructor</code>中就注册监听事件</p>
</blockquote>
<p>收回来，进入<code>if</code>继续看。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.unlisten = props.history.listen(<span class="function"><span class="params">location</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._isMounted) &#123;</span><br><span class="line">  	<span class="keyword">this</span>.setState(&#123; location &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  	<span class="keyword">this</span>._pendingLocation = location;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>就是调用了<code>history</code>的<code>listen</code>方法。从代码中可以大致了解到就是对<code>history</code>进行监听，然后进行一些操作。</p>
<h3 id="componentWillUnmount"><a href="#componentWillUnmount" class="headerlink" title="componentWillUnmount"></a>componentWillUnmount</h3><p>那么这个<code>unlisten</code>什么时候执行呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.unlisten) &#123;</span><br><span class="line">      <span class="keyword">this</span>.unlisten();</span><br><span class="line">      <span class="keyword">this</span>._isMounted = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">this</span>._pendingLocation = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Router</code>这个组件卸载的时候就执行啦。也就是说，取消了对<code>history</code>的监听。</p>
<h3 id="componentDidUnmount"><a href="#componentDidUnmount" class="headerlink" title="componentDidUnmount"></a>componentDidUnmount</h3><p>然后看一下<code>conponentDidMount</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>._isMounted = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._pendingLocation) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">location</span>: <span class="keyword">this</span>._pendingLocation &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>也很简单，就是修改一下是否挂载的值，以及继续之前在构造函数里面的判断。如果暂存数据有的话就把他存下来。</p>
<h3 id="render"><a href="#render" class="headerlink" title="render"></a>render</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;RouterContext.Provider</span><br><span class="line">        value&#x3D;&#123;&#123;</span><br><span class="line">          &#x2F;&#x2F; 根据 HashRouter 还是 BrowserRouter，可判断 history 类型</span><br><span class="line">          history: this.props.history,</span><br><span class="line">          &#x2F;&#x2F; 这个 location 就是监听 history 变化得到的 location</span><br><span class="line">          location: this.state.location,</span><br><span class="line">          &#x2F;&#x2F; path url params isExact 四个属性</span><br><span class="line">          match: Router.computeRootMatch(this.state.location.pathname),</span><br><span class="line">          &#x2F;&#x2F; 只有 StaticRouter 会传 staticContext</span><br><span class="line">          &#x2F;&#x2F; HashRouter 和 BrowserRouter 都是 null</span><br><span class="line">          staticContext: this.props.staticContext</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;HistoryContext.Provider</span><br><span class="line">          children&#x3D;&#123;this.props.children || null&#125;</span><br><span class="line">          value&#x3D;&#123;this.props.history&#125;</span><br><span class="line">        &#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;RouterContext.Provider&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Router这个组件主要就是将一些数据进行存储。存到<code>Context</code>，之间不乏一些特殊情况的判断，比如子组件渲染比父组件早，以及<code>Redirect</code>的情况的处理。在卸载的时候要移除对<code>history</code>的监听。</p>
<p>子组件作为消费者，就可以对页面进行修改，跳转，获取这些数值。</p>
<h2 id="history"><a href="#history" class="headerlink" title="history"></a>history</h2><h3 id="createBrowserHistory"><a href="#createBrowserHistory" class="headerlink" title="createBrowserHistory"></a>createBrowserHistory</h3><h4 id="返回的内容"><a href="#返回的内容" class="headerlink" title="返回的内容"></a>返回的内容</h4><p>之前一直有不断提到的<code>history</code>，我们一起来看看它是谁</p>
<p>源码连接：<a href="https://github.com/ReactTraining/history/blob/master/packages/history/index.ts" target="_blank" rel="noopener">https://github.com/ReactTraining/history/blob/master/packages/history/index.ts</a></p>
<p>我们之前用到的<code>createBrowserHistory</code>，他其实是返回的一个对象，这个对象里面有我们常用的一些方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> history: BrowserHistory = &#123;</span><br><span class="line">    <span class="keyword">get</span> action() &#123;</span><br><span class="line">      <span class="keyword">return</span> action;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">get</span> location() &#123;</span><br><span class="line">      <span class="keyword">return</span> location;</span><br><span class="line">    &#125;,</span><br><span class="line">    createHref,</span><br><span class="line">    push,</span><br><span class="line">    replace,</span><br><span class="line">    go,</span><br><span class="line">    back() &#123;</span><br><span class="line">      go(<span class="number">-1</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    forward() &#123;</span><br><span class="line">      go(<span class="number">1</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    listen(listener) &#123;</span><br><span class="line">      <span class="keyword">return</span> listeners.push(listener);</span><br><span class="line">    &#125;,</span><br><span class="line">    block(blocker) &#123;</span><br><span class="line">      <span class="keyword">let</span> unblock = blockers.push(blocker);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (blockers.length === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">window</span>.addEventListener(BeforeUnloadEventType, promptBeforeUnload);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        unblock();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove the beforeunload listener so the document may</span></span><br><span class="line">        <span class="comment">// still be salvageable in the pagehide event.</span></span><br><span class="line">        <span class="comment">// See https://html.spec.whatwg.org/#unloading-documents</span></span><br><span class="line">        <span class="keyword">if</span> (!blockers.length) &#123;</span><br><span class="line">          <span class="built_in">window</span>.removeEventListener(BeforeUnloadEventType, promptBeforeUnload);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> history;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大部分精髓就是这里。发现有多熟悉的伙伴！ =&gt; <code>push</code>、<code>replace</code>、<code>go</code>等等。有些其实都是<code>window</code>提供的。</p>
<p>有些直接看代码就可以明白的就不解释了，比如<code>forward</code>，<code>back</code>。</p>
<h5 id="go"><a href="#go" class="headerlink" title="go"></a>go</h5><p>比如上面提到的<code>go</code>方法，截取部分源码。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> globalHistory = <span class="built_in">window</span>.history;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">go</span>(<span class="params">delta: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">    globalHistory.go(delta);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h5 id="createHref"><a href="#createHref" class="headerlink" title="createHref"></a>createHref</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 返回一个完整的url</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPath</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  pathname = '/',</span></span></span><br><span class="line"><span class="function"><span class="params">  search = '',</span></span></span><br><span class="line"><span class="function"><span class="params">  hash = ''</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;: PartialPath</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> pathname + search + hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个url</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createHref</span>(<span class="params">to: To</span>) </span>&#123;</span><br><span class="line">  	<span class="comment">// 看上面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> to === <span class="string">'string'</span> ? to : createPath(to);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h5 id="push"><a href="#push" class="headerlink" title="push"></a>push</h5><p><code>push</code>的源码，里面附带了一些会用到的函数。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 就是简单处理一下返回值。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNextLocation</span>(<span class="params">to: To, state: State = <span class="literal">null</span></span>): <span class="title">Location</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> readOnly&lt;Location&gt;(&#123;</span><br><span class="line">    ...location,</span><br><span class="line">    ...(<span class="keyword">typeof</span> to === <span class="string">'string'</span> ? parsePath(to) : to),</span><br><span class="line">    state,</span><br><span class="line">    key: createKey()</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进行判断</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allowTx</span>(<span class="params">action: Action, location: Location, retry: () =&gt; <span class="built_in">void</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="comment">// 长度为0就返回true，长度大于0就调用函数，并传入参数。这个blockers等一下仔细探讨一下</span></span><br><span class="line">      !blockers.length || (blockers.call(&#123; action, location, retry &#125;), <span class="literal">false</span>)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 顾名思义获取state和url</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHistoryStateAndUrl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    nextLocation: Location,</span></span></span><br><span class="line"><span class="function"><span class="params">    index: <span class="built_in">number</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): [<span class="title">HistoryState</span>, <span class="title">string</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      &#123;</span><br><span class="line">        usr: nextLocation.state,</span><br><span class="line">        key: nextLocation.key,</span><br><span class="line">        idx: index</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 看上面 有专门介绍</span></span><br><span class="line">      createHref(nextLocation)</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一些关于location的信息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIndexAndLocation</span>(<span class="params"></span>): [<span class="title">number</span>, <span class="title">Location</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; pathname, search, hash &#125; = <span class="built_in">window</span>.location;</span><br><span class="line">    <span class="keyword">let</span> state = globalHistory.state || &#123;&#125;;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      state.idx,</span><br><span class="line">      readOnly&lt;Location&gt;(&#123;</span><br><span class="line">        pathname,</span><br><span class="line">        search,</span><br><span class="line">        hash,</span><br><span class="line">        state: state.usr || <span class="literal">null</span>,</span><br><span class="line">        key: state.key || <span class="string">'default'</span></span><br><span class="line">      &#125;)</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行listeners内部的一些函数（也就是跳转），后面也会详细解读</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyTx</span>(<span class="params">nextAction: Action</span>) </span>&#123;</span><br><span class="line">    action = nextAction;</span><br><span class="line">    [index, location] = getIndexAndLocation();</span><br><span class="line">    listeners.call(&#123; action, location &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">to: To, state?: State</span>) </span>&#123;</span><br><span class="line">  	<span class="comment">// 这里是一个枚举值</span></span><br><span class="line">    <span class="keyword">let</span> nextAction = Action.Push;</span><br><span class="line">  	</span><br><span class="line">    <span class="keyword">let</span> nextLocation = getNextLocation(to, state);</span><br><span class="line">  	<span class="comment">// 顾名思义，就是再来一次</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">retry</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      push(to, state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (allowTx(nextAction, nextLocation, retry)) &#123;</span><br><span class="line">      <span class="keyword">let</span> [historyState, url] = getHistoryStateAndUrl(nextLocation, index + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Support forced reloading</span></span><br><span class="line">      <span class="comment">// try...catch because iOS limits us to 100 pushState calls :/</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// MDN的地址: https://developer.mozilla.org/zh-CN/docs/Web/API/History/pushState</span></span><br><span class="line">        globalHistory.pushState(historyState, <span class="string">''</span>, url);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="comment">// They are going to lose state here, but there is no real</span></span><br><span class="line">        <span class="comment">// way to warn them about it since the page will refresh...</span></span><br><span class="line">        <span class="comment">// MDN的地址: https://developer.mozilla.org/zh-CN/docs/Web/API/Location/assign</span></span><br><span class="line">        <span class="built_in">window</span>.location.assign(url);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      applyTx(nextAction);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>我在注释里面已经进行非常详细的解读了，用到的每个函数都有解释或者官方权威的url。</p>
<p>总结一下：<code>history.push</code>的一个完整流程</p>
<ul>
<li>调用<code>history.pushState</code><ul>
<li>错误由<code>window.location.assign</code>来处理</li>
</ul>
</li>
<li>执行一下<code>listeners</code>里面的函数</li>
</ul>
<p>是的，你没有看错，就这么简单，只是里面有很多调用的函数，我都截取出来一一解释，做到每行代码都理解，所以显得比较长，概括来说就是这么简单。</p>
<p>重点来看一下<code>listen</code>和被调用的<code>createBrowserHistory</code></p>
<h5 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h5><p>这里面用的函数，在前面的push都有解析，可以往上面去找找，就不多赘述了。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace</span>(<span class="params">to: To, state?: State</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> nextAction = Action.Replace;</span><br><span class="line">    <span class="keyword">let</span> nextLocation = getNextLocation(to, state);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">retry</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      replace(to, state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (allowTx(nextAction, nextLocation, retry)) &#123;</span><br><span class="line">      <span class="keyword">let</span> [historyState, url] = getHistoryStateAndUrl(nextLocation, index);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Support forced reloading</span></span><br><span class="line">      globalHistory.replaceState(historyState, <span class="string">''</span>, url);</span><br><span class="line"></span><br><span class="line">      applyTx(nextAction);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h5 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h5><p>在<code>history</code>返回的<code>listen</code>是一个函数。这个函数我们之前在react-router的源码中发现，他是在构造函数和卸载的时候会用到。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listen(listener) &#123;</span><br><span class="line">      <span class="keyword">return</span> listeners.push(listener);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>仔细看看，这个<code>listeners</code>是在做些什么。</p>
<h5 id="createEvents"><a href="#createEvents" class="headerlink" title="createEvents"></a>createEvents</h5><p>这个函数后面的blockers也会用到</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> listeners = createEvents&lt;Listener&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEvents</span>&lt;<span class="title">F</span> <span class="title">extends</span> <span class="title">Function</span>&gt;(<span class="params"></span>): <span class="title">Events</span>&lt;<span class="title">F</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> handlers: F[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> length() &#123;</span><br><span class="line">      <span class="keyword">return</span> handlers.length;</span><br><span class="line">    &#125;,</span><br><span class="line">    push(fn: F) &#123;</span><br><span class="line">      handlers.push(fn);</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        handlers = handlers.filter(<span class="function"><span class="params">handler</span> =&gt;</span> handler !== fn);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    call(arg) &#123;</span><br><span class="line">      handlers.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn &amp;&amp; fn(arg));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法，顾名思义，就是创建事件。定义了一个变量 <code>handlers</code> 数组，用于存放要处理的回调函数事件。</p>
<p>然后返回了一个对象。</p>
<p><code>push</code> 方法就是往 <code>handlers</code> 中添加要执行的函数。</p>
<p>这块主要在 <code>history.listen()</code> 中使用，可以翻到开头看下 <code>history</code> 中返回了 <code>listen()</code> 方法，就是调用了<code>listeners.push(listener)</code> 。</p>
<p>最后 <code>call()</code> 方法就比较容易理解，就是取出 <code>handlers</code> 里面的回调函数并逐个执行。</p>
<p>总结一下，就是存储一下<code>push</code>进来的函数，并进行过滤。之后调用的时候会依次执行。<code>length</code>就是当前拥有的函数数量。</p>
<p>再切回去，就会发现，每次调用这个<code>listen</code>就相当于<code>push</code>一个函数到内部的一个变量<code>handlers</code>中。</p>
<h5 id="block"><a href="#block" class="headerlink" title="block"></a>block</h5><p>和<code>listeners</code>一样，也是用<code>createEvents</code>创建的，就不多说啦。说一下哪里会用到这个吧。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> blockers = createEvents&lt;Blocker&gt;();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>block(prompt)</code> - (function) Prevents navigation (see <a href="https://github.com/ReactTraining/history/blob/master/docs/blocking-transitions.md" target="_blank" rel="noopener">the history docs</a>)</li>
</ul>
<p>这个是<code>react-router</code>官网的解释。</p>
<p>我这里简单概括一下，就是用于关闭或者回退浏览器的误操作会用到的。详细的可以看点击进去查看。</p>
<h5 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h5><p>至此，我们调用的<code>createBrowserHistory</code>所返回的一些属性的源码都已经了如指掌了。但是具体是怎么工作还是一知半解。</p>
<h4 id="具体核心原理"><a href="#具体核心原理" class="headerlink" title="具体核心原理"></a>具体核心原理</h4><p>先秀一下源码。history的核心原理就是这个。先别被这么多行代码唬到了，很多都是我们在之前的push里面有解释的</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PopStateEventType = <span class="string">'popstate'</span>;</span><br><span class="line"><span class="keyword">let</span> blockedPopTx: Transition | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlePop</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果有</span></span><br><span class="line">  <span class="keyword">if</span> (blockedPopTx) &#123;</span><br><span class="line">    blockers.call(blockedPopTx);</span><br><span class="line">    blockedPopTx = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> nextAction = Action.Pop;</span><br><span class="line">    <span class="keyword">let</span> [nextIndex, nextLocation] = getIndexAndLocation();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (blockers.length) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nextIndex != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> delta = index - nextIndex;</span><br><span class="line">        <span class="keyword">if</span> (delta) &#123;</span><br><span class="line">          <span class="comment">// Revert the POP</span></span><br><span class="line">          blockedPopTx = &#123;</span><br><span class="line">            action: nextAction,</span><br><span class="line">            location: nextLocation,</span><br><span class="line">            retry() &#123;</span><br><span class="line">              go(delta * <span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">          go(delta);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Trying to POP to a location with no index. We did not create</span></span><br><span class="line">        <span class="comment">// this location, so we can't effectively block the navigation.</span></span><br><span class="line">        warning(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> Write up a doc that explains our blocking strategy in</span></span><br><span class="line">          <span class="comment">// detail and link to it here so people can understand better what</span></span><br><span class="line">          <span class="comment">// is going on and how to avoid it.</span></span><br><span class="line">          <span class="string">`You are trying to block a POP navigation to a location that was not `</span> +</span><br><span class="line">          <span class="string">`created by the history library. The block will fail silently in `</span> +</span><br><span class="line">          <span class="string">`production, but in general you should do all navigation with the `</span> +</span><br><span class="line">          <span class="string">`history library (instead of using window.history.pushState directly) `</span> +</span><br><span class="line">          <span class="string">`to avoid this situation.`</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      applyTx(nextAction);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(PopStateEventType, handlePop);</span><br></pre></td></tr></table></figure>

<p>重点说一下<code>window.addEventListener(PopStateEventType, handlePop)</code></p>
<p>MDN地址：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/popstate_event" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/Window/popstate_event</a></p>
<p>其实就是监听路由的变化然后，执行回调函数</p>
<h3 id="createHashHistory"><a href="#createHashHistory" class="headerlink" title="createHashHistory"></a>createHashHistory</h3><p>这个大体上与普通路由一致。这里我想强调一些问题。</p>
<blockquote>
<p>比如哈希路由的锚点问题，我自己已知的几个方案</p>
<ul>
<li><h3 id="scrollIntoView"><a href="#scrollIntoView" class="headerlink" title="scrollIntoView"></a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollIntoView" target="_blank" rel="noopener">scrollIntoView</a></h3></li>
<li><h3 id="scrollTop"><a href="#scrollTop" class="headerlink" title="scrollTop"></a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollTop" target="_blank" rel="noopener">scrollTop</a></h3></li>
<li><h2 id="react-anchor-without-hash"><a href="#react-anchor-without-hash" class="headerlink" title="react-anchor-without-hash"></a><a href="https://github.com/kwzm/react-anchor-without-hash" target="_blank" rel="noopener">react-anchor-without-hash</a></h2></li>
</ul>
</blockquote>
<p>感兴趣的自己查询一下，这个不在本次的讨论范围内。</p>
<h4 id="具体核心原理-1"><a href="#具体核心原理-1" class="headerlink" title="具体核心原理"></a>具体核心原理</h4><p>之前说的到，<code>history</code>路由的核心是<code>window.addEventListener(PopStateEventType, handlePop);</code></p>
<p>而哈希路由的核心也是监听路由的变化，只是参数不同。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'hashchange'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="comment">/* 监听改变 */</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>而对路由的改变。<code>history</code>路由是：<code>history.pushState</code>，<code>history.replaceState</code>。</p>
<p>哈希路由是：</p>
<p><code>window.location.hash</code></p>
<p>通过<code>window.location.hash</code>属性获取和设置 <code>hash</code>值。</p>
<p>具体的话很差不多，关心细节的伙伴可以去看其源码哦。</p>
<h1 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h1><p>之前我们看了BrowserRouter。我们回过头来看看，demo中的实例代码还有多少没有解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import React from &#39;react&#39;;</span><br><span class="line">import &#123;</span><br><span class="line">  BrowserRouter as Router,</span><br><span class="line">  Switch,</span><br><span class="line">  Route,</span><br><span class="line">  Link,</span><br><span class="line">&#125; from &quot;react-router-dom&quot;;</span><br><span class="line"></span><br><span class="line">function Home() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;首页&lt;&#x2F;h1&gt;</span><br><span class="line">      &lt;Link to&#x3D;&quot;&#x2F;login&quot;&gt;登录&lt;&#x2F;Link&gt;</span><br><span class="line">    &lt;&#x2F;&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function Login() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;登录页&lt;&#x2F;h1&gt;</span><br><span class="line">      &lt;Link to&#x3D;&quot;&#x2F;&quot;&gt;回首页&lt;&#x2F;Link&gt;</span><br><span class="line">    &lt;&#x2F;&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function App() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;Router&gt;</span><br><span class="line">      &lt;Switch&gt;</span><br><span class="line">        &lt;Route path&#x3D;&quot;&#x2F;login&quot; component&#x3D;&#123;Login&#125;&#x2F;&gt;</span><br><span class="line">        &lt;Route path&#x3D;&quot;&#x2F;&quot; component&#x3D;&#123;Home&#125;&#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;Switch&gt;</span><br><span class="line">    &lt;&#x2F;Router&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default App;</span><br></pre></td></tr></table></figure>

<p>我们已经看完了<code>BrowserRouter</code>（<code>Router</code>。下面还有<code>Switch</code>和<code>Route</code>。</p>
<h2 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h2><p>先上源码。我摘取最核心的一部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">class Switch extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;RouterContext.Consumer&gt;</span><br><span class="line">        &#123;context &#x3D;&gt; &#123;</span><br><span class="line">          invariant(context, &quot;You should not use &lt;Switch&gt; outside a &lt;Router&gt;&quot;);</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F; 默认使用context.location，如果有特殊定制的location才会使用。</span><br><span class="line">          &#x2F;&#x2F; 下面有介绍</span><br><span class="line">          const location &#x3D; this.props.location || context.location;</span><br><span class="line"></span><br><span class="line">          let element, match;</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F; We use React.Children.forEach instead of React.Children.toArray().find()</span><br><span class="line">          &#x2F;&#x2F; here because toArray adds keys to all child elements and we do not want</span><br><span class="line">          &#x2F;&#x2F; to trigger an unmount&#x2F;remount for two &lt;Route&gt;s that render the same</span><br><span class="line">          &#x2F;&#x2F; component at different URLs.</span><br><span class="line">          &#x2F;&#x2F; React.Children.forEach 对子元素做遍历</span><br><span class="line">          React.Children.forEach(this.props.children, child &#x3D;&gt; &#123;</span><br><span class="line">            &#x2F;&#x2F; 只要找到一个 match，那么就不会再进来了</span><br><span class="line">            if (match &#x3D;&#x3D; null &amp;&amp; React.isValidElement(child)) &#123;</span><br><span class="line">              element &#x3D; child;</span><br><span class="line"></span><br><span class="line">              &#x2F;&#x2F; child.props.path 就不多讲了， Route 的标准写法</span><br><span class="line">              &#x2F;&#x2F; 需要注意的是，使用 from 也会被匹配到</span><br><span class="line">              &#x2F;&#x2F; 任何组件，只要在 Switch 下，有 from 属性，并且和当前路径匹配，就会被渲染</span><br><span class="line">              &#x2F;&#x2F; from具体是给&lt;Redirect&gt;使用的，后面会说到</span><br><span class="line">              const path &#x3D; child.props.path || child.props.from;</span><br><span class="line"></span><br><span class="line">              &#x2F;&#x2F; 判断组件是否匹配</span><br><span class="line">              match &#x3D; path</span><br><span class="line">              &#x2F;&#x2F; 下面有专属的介绍这个函数</span><br><span class="line">                ? matchPath(location.pathname, &#123; ...child.props, path &#125;)</span><br><span class="line">                : context.match;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">          return match</span><br><span class="line">            ? React.cloneElement(element, &#123; location, computedMatch: match &#125;)</span><br><span class="line">            : null;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &lt;&#x2F;RouterContext.Consumer&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Switch中的location这个props怎么用？什么用？</p>
<blockquote>
<h2 id="摘自官网"><a href="#摘自官网" class="headerlink" title="摘自官网"></a>摘自官网</h2><h2 id="location-object"><a href="#location-object" class="headerlink" title="location: object"></a><a href="https://reactrouter.com/web/api/Switch/location-object" target="_blank" rel="noopener">location: object</a></h2><p>A <a href="https://reactrouter.com/web/api/location" target="_blank" rel="noopener"><code>location</code></a> object to be used for matching children elements instead of the current history location (usually the current browser URL).</p>
<p>谷歌翻译：用于匹配子元素的位置对象，而不是当前历史记录位置（通常是当前浏览器URL）。</p>
</blockquote>
<h3 id="matchPath"><a href="#matchPath" class="headerlink" title="matchPath"></a>matchPath</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchPath</span>(<span class="params">pathname, options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 规范结构体</span></span><br><span class="line">  <span class="comment">// 如果 options 传的是个 string，那默认这个 string 代表 path</span></span><br><span class="line">  <span class="comment">// 如果 options 传的是个 数组，那只要有一个匹配，就认为匹配</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">"string"</span> || <span class="built_in">Array</span>.isArray(options)) &#123;</span><br><span class="line">    options = &#123; <span class="attr">path</span>: options &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; path, exact = <span class="literal">false</span>, strict = <span class="literal">false</span>, sensitive = <span class="literal">false</span> &#125; = options;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转化成数组进行判断</span></span><br><span class="line">  <span class="keyword">const</span> paths = [].concat(path);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 都是很简单的内容，难点就在这个reduce，这个很有意思，感兴趣或者不了解的赶紧去MDN了解一下！！！</span></span><br><span class="line">  <span class="keyword">return</span> paths.reduce(<span class="function">(<span class="params">matched, path</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!path &amp;&amp; path !== <span class="string">""</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 只要有一个 match，直接返回，认为是 match</span></span><br><span class="line">    <span class="keyword">if</span> (matched) <span class="keyword">return</span> matched;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// regexp 是正则表达式</span></span><br><span class="line">    <span class="comment">// keys 是切割出来的得 key 的值</span></span><br><span class="line">    <span class="keyword">const</span> &#123; regexp, keys &#125; = compilePath(path, &#123;</span><br><span class="line">      end: exact,</span><br><span class="line">      strict,</span><br><span class="line">      sensitive</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// exec() 该方法如果找到了匹配的文本的话，则会返回一个结果数组，否则的话，会返回一个</span></span><br><span class="line">    <span class="keyword">const</span> match = regexp.exec(pathname);</span><br><span class="line">    <span class="comment">/* 匹配不成功，返回null */</span></span><br><span class="line">    <span class="keyword">if</span> (!match) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// url 表示匹配到的部分</span></span><br><span class="line">    <span class="keyword">const</span> [url, ...values] = match;</span><br><span class="line">    <span class="comment">// pathname === url 表示完全匹配</span></span><br><span class="line">    <span class="keyword">const</span> isExact = pathname === url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (exact &amp;&amp; !isExact) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      path, <span class="comment">// the path used to match</span></span><br><span class="line">      url: path === <span class="string">"/"</span> &amp;&amp; url === <span class="string">""</span> ? <span class="string">"/"</span> : url, <span class="comment">// the matched portion of the URL</span></span><br><span class="line">      isExact, <span class="comment">// whether or not we matched exactly</span></span><br><span class="line">      params: keys.reduce(<span class="function">(<span class="params">memo, key, index</span>) =&gt;</span> &#123;</span><br><span class="line">        memo[key.name] = values[index];</span><br><span class="line">        <span class="keyword">return</span> memo;</span><br><span class="line">      &#125;, &#123;&#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>matchPath 函数也是由 react-router export 出去的函数，我们可以用来获得某个 url 中的指定的参数。</p>
<h2 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h2><p>Route 是用于声明路由映射到应用程序的组件层。</p>
<p>Route 有三种渲染的方法，当然，都配置的话只有一个会生效，优先级是 children &gt; component &gt; render</p>
<p>\1. <Route component><br>\2. <Route render><br>\3. <Route children></p>
<p>每个在不同的情况下都有用，大多数情况下，会使用 component。</p>
<h3 id="component"><a href="#component" class="headerlink" title="component"></a>component</h3><p>component 表示只有当位置匹配时才会渲染的 React 组件。使用 component（而不是 render 或 children ）Route 使用从给定组件 React.createElement(element, props) 创建新的 React element。这意味着，使用 component 创建的组件能获得 router 中的 props。</p>
<h3 id="children"><a href="#children" class="headerlink" title="children"></a>children</h3><p>从源码中可以看出，children 的优先级是高于 component，而且可以是一个组件，也可以是一个函数，children 没有获得 router 的 props。</p>
<p>children 有一个非常特殊的地方在于，当路由不匹配且 children 是一个函数的时候，会执行 children 方法，这就给了设计很大的灵活性。</p>
<h3 id="render-1"><a href="#render-1" class="headerlink" title="render"></a>render</h3><p>render 必须是一个函数，优先级是最低的，当匹配成功的时候，执行这个函数。</p>
<h3 id="exact-amp-strict-amp-sensitive"><a href="#exact-amp-strict-amp-sensitive" class="headerlink" title="exact &amp; strict &amp; sensitive"></a>exact &amp; strict &amp; sensitive</h3><p>这三者都是使用 path-to-regexp 做路径匹配需要的三个参数。</p>
<ol>
<li>exact: 如果为 true，则只有在路径完全匹配 location.pathname 时才匹配。</li>
<li>strict: 在确定为位置是否与当前 URL 匹配时，将考虑位置 pathname 后的斜线。</li>
<li>sensitive: 如果路径区分大小写，则为 true ，则匹配。</li>
</ol>
<h3 id="location"><a href="#location" class="headerlink" title="location"></a>location</h3><p>Route 元素尝试其匹配 path 到当前浏览器 URL，但是，也可以通过 location 实现与当前浏览器位置以外的位置相匹配。</p>
<p>下面列出 Route 源码，并且删去了 dev 部分。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isValidElementType &#125; <span class="keyword">from</span> <span class="string">"react-is"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> invariant <span class="keyword">from</span> <span class="string">"tiny-invariant"</span>;</span><br><span class="line"><span class="keyword">import</span> warning <span class="keyword">from</span> <span class="string">"tiny-warning"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> RouterContext <span class="keyword">from</span> <span class="string">"./RouterContext.js"</span>;</span><br><span class="line"><span class="keyword">import</span> matchPath <span class="keyword">from</span> <span class="string">"./matchPath.js"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The public API for matching a single path and rendering.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;RouterContext.Consumer&gt;</span><br><span class="line">        &#123;context =&gt; &#123;</span><br><span class="line">          invariant(context, <span class="string">"You should not use &lt;Route&gt; outside a &lt;Router&gt;"</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 可以看出，用户传的 location 覆盖掉了 context 中的 location</span></span><br><span class="line">          <span class="keyword">const</span> location = <span class="keyword">this</span>.props.location || context.location;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 如果有 computedMatch 就用 computedMatch 作为结果</span></span><br><span class="line">          <span class="comment">// 如果没有，则判断是否有 path 传参</span></span><br><span class="line">          <span class="comment">// matchPath 是调用 path-to-regexp 判断是否匹配</span></span><br><span class="line">          <span class="comment">// path-to-regexp 需要三个参数</span></span><br><span class="line">          <span class="comment">// exact: 如果为 true，则只有在路径完全匹配 location.pathname 时才匹配</span></span><br><span class="line">          <span class="comment">// strict: 如果为 true 当真实的路径具有一个斜线将只匹配一个斜线location.pathname</span></span><br><span class="line">          <span class="comment">// sensitive: 如果路径区分大小写，则为 true ，则匹配</span></span><br><span class="line">          <span class="keyword">const</span> match = <span class="keyword">this</span>.props.computedMatch</span><br><span class="line">            ? <span class="keyword">this</span>.props.computedMatch <span class="comment">// &lt;Switch&gt; already computed the match for us</span></span><br><span class="line">            : <span class="keyword">this</span>.props.path</span><br><span class="line">            ? matchPath(location.pathname, <span class="keyword">this</span>.props)</span><br><span class="line">            : context.match;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// props 就是更新后的 context</span></span><br><span class="line">          <span class="comment">// location 做了更新（有可能是用户传入的location）</span></span><br><span class="line">          <span class="comment">// match 做了更新</span></span><br><span class="line">          <span class="keyword">const</span> props = &#123; ...context, location, match &#125;;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 三种渲染方式</span></span><br><span class="line">          <span class="keyword">let</span> &#123; children, component, render &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Preact uses an empty array as children by</span></span><br><span class="line">          <span class="comment">// default, so use null if that's the case.</span></span><br><span class="line">          <span class="comment">// children 默认是个空数组，如果是默认情况，置为 null</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children) &amp;&amp; children.length === <span class="number">0</span>) &#123;</span><br><span class="line">            children = <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> (</span><br><span class="line">            <span class="comment">// RouterContext 中更新了 location, match</span></span><br><span class="line">            &lt;RouterContext.Provider value=&#123;props&#125;&gt;</span><br><span class="line">              &#123;props.match</span><br><span class="line">              <span class="comment">// 首先判断的是有无 children</span></span><br><span class="line">                ? children</span><br><span class="line">                  <span class="comment">// 如果 children 是个函数，执行，否则直接返回 children</span></span><br><span class="line">                  ? <span class="keyword">typeof</span> children === <span class="string">"function"</span></span><br><span class="line">                  : children(props)</span><br><span class="line">                  : children</span><br><span class="line">                  <span class="comment">// 如果没有 children，判断有无 component</span></span><br><span class="line">                : component</span><br><span class="line">                  <span class="comment">// 有 component，重新新建一个 component</span></span><br><span class="line">                  ? React.createElement(component, props)</span><br><span class="line">                  <span class="comment">// 没有 component，判断有无 render</span></span><br><span class="line">                  : render</span><br><span class="line">                  <span class="comment">// 有 render，执行 render 方法</span></span><br><span class="line">                  ? render(props)</span><br><span class="line">                  <span class="comment">// 没有返回 null</span></span><br><span class="line">                  : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 这里是不 match 的情况，判断 children 是否函数</span></span><br><span class="line">                : <span class="keyword">typeof</span> children === <span class="string">"function"</span></span><br><span class="line">                <span class="comment">// 是的话执行</span></span><br><span class="line">                ? children(props)</span><br><span class="line">                : <span class="literal">null</span>&#125;</span><br><span class="line">            &lt;<span class="regexp">/RouterContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">          );</span></span><br><span class="line"><span class="regexp">        &#125;&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>RouterContext.Consumer&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Route;</span><br></pre></td></tr></table></figure>

<p>Route 组件根据自身的传参，对上层 RouterContext 中的部分属性（location 和 match）进行了更新，并且如果当前路径和配置的 path 路径 match，则渲染该组件，渲染的方式有 children，component，render 三种方式，我们最常用的就是 component 方式，注意每种方式的区别。</p>
<h2 id="Prompt"><a href="#Prompt" class="headerlink" title="Prompt"></a>Prompt</h2><p>Prompt 用于路由切换提示。这在某些场景下是非常有用的，比如用户在某个页面修改数据，离开时，提示用户是否保存，Prompt 组件有俩个属性：</p>
<ol>
<li>message：用于显示提示的文本信息。</li>
<li>when：传递布尔值，相当于标签的开关，默认是 true，设置成 false 时，失效。</li>
</ol>
<p>Prompt 的本质是在 when 为 true 的时候，调用 context.history.block 方法，为全局注册路由监听，block 的原理看之前的 history 相关文章。路有变化的时候，默认使用 window.confirm 进行确认，我们也可以自定义 confirm 的形式，就是在 BrowserRouter 或者 HashRouter 传入 getUserConfirmation 这个参数，会替换掉 window.confirm。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import React from &quot;react&quot;;</span><br><span class="line">import PropTypes from &quot;prop-types&quot;;</span><br><span class="line">import invariant from &quot;tiny-invariant&quot;;</span><br><span class="line"></span><br><span class="line">import Lifecycle from &quot;.&#x2F;Lifecycle.js&quot;;</span><br><span class="line">import RouterContext from &quot;.&#x2F;RouterContext.js&quot;;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * The public API for prompting the user before navigating away from a screen.</span><br><span class="line"> *&#x2F;</span><br><span class="line">function Prompt(&#123; message, when &#x3D; true &#125;) &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;RouterContext.Consumer&gt;</span><br><span class="line">      &#123;context &#x3D;&gt; &#123;</span><br><span class="line">        invariant(context, &quot;You should not use &lt;Prompt&gt; outside a &lt;Router&gt;&quot;);</span><br><span class="line"></span><br><span class="line">        if (!when || context.staticContext) return null;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 调用了 history.block 方法</span><br><span class="line">        const method &#x3D; context.history.block;</span><br><span class="line"></span><br><span class="line">        return (</span><br><span class="line">          &lt;Lifecycle</span><br><span class="line">            onMount&#x3D;&#123;self &#x3D;&gt; &#123;</span><br><span class="line">              self.release &#x3D; method(message);</span><br><span class="line">            &#125;&#125;</span><br><span class="line">            onUpdate&#x3D;&#123;(self, prevProps) &#x3D;&gt; &#123;</span><br><span class="line">              if (prevProps.message !&#x3D;&#x3D; message) &#123;</span><br><span class="line">                self.release();</span><br><span class="line">                self.release &#x3D; method(message);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;&#125;</span><br><span class="line">            onUnmount&#x3D;&#123;self &#x3D;&gt; &#123;</span><br><span class="line">              self.release();</span><br><span class="line">            &#125;&#125;</span><br><span class="line">            message&#x3D;&#123;message&#125;</span><br><span class="line">          &#x2F;&gt;</span><br><span class="line">        );</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &lt;&#x2F;RouterContext.Consumer&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default Prompt;</span><br></pre></td></tr></table></figure>

<h2 id="Redirect"><a href="#Redirect" class="headerlink" title="Redirect"></a>Redirect</h2><p>Redirect 与其说是一个组件，不如说是有组件封装的一组方法，该组件在 componentDidMount 生命周期内，通过调用 history API 跳转到到新位置，默认情况下，新位置将覆盖历史堆栈中的当前位置。</p>
<p><Redirect to="/somewhere/else"/> to 表示要重定向到的网址。to 也可以是一个 location 对象</p>
<p><Redirect push to="/somewhere/else"/> push 为 true 时，重定向会将新条目推入历史记录，而不是替换当前条目。</p>
<p>结合 Switch 和 Redirect 源码看，如果 Redirect 中有 from 属性，会被 Switch 获得，当 from 和当前路径匹配的时候，就会渲染 Redirect 组件，执行跳转。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">"prop-types"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createLocation, locationsAreEqual &#125; <span class="keyword">from</span> <span class="string">"history"</span>;</span><br><span class="line"><span class="keyword">import</span> invariant <span class="keyword">from</span> <span class="string">"tiny-invariant"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Lifecycle <span class="keyword">from</span> <span class="string">"./Lifecycle.js"</span>;</span><br><span class="line"><span class="keyword">import</span> RouterContext <span class="keyword">from</span> <span class="string">"./RouterContext.js"</span>;</span><br><span class="line"><span class="keyword">import</span> generatePath <span class="keyword">from</span> <span class="string">"./generatePath.js"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The public API for navigating programmatically with a component.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Redirect</span>(<span class="params">&#123; computedMatch, to, push = false &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// 啥都有的大哥 RouterContext</span></span><br><span class="line">    &lt;RouterContext.Consumer&gt;</span><br><span class="line">      &#123;context =&gt; &#123;</span><br><span class="line">        invariant(context, <span class="string">"You should not use &lt;Redirect&gt; outside a &lt;Router&gt;"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; history, staticContext &#125; = context;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一般来说，Redirect 操作都不需要留有 history，所以选择选择 history.replace</span></span><br><span class="line">        <span class="keyword">const</span> method = push ? history.push : history.replace;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> location = createLocation(</span><br><span class="line">          <span class="comment">// computedMatch 就是看看 switch 有没有多管闲事</span></span><br><span class="line">          computedMatch</span><br><span class="line">            ? <span class="keyword">typeof</span> to === <span class="string">"string"</span></span><br><span class="line">              ? generatePath(to, computedMatch.params)</span><br><span class="line">              : &#123;</span><br><span class="line">                  ...to,</span><br><span class="line">                  pathname: generatePath(to.pathname, computedMatch.params)</span><br><span class="line">                &#125;</span><br><span class="line">            : to</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// When rendering in a static context,</span></span><br><span class="line">        <span class="comment">// set the new location immediately.</span></span><br><span class="line">        <span class="comment">// staticRouter 专用</span></span><br><span class="line">        <span class="keyword">if</span> (staticContext) &#123;</span><br><span class="line">          method(location);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;Lifecycle</span><br><span class="line">            onMount=&#123;() =&gt; &#123;</span><br><span class="line">              <span class="comment">// componentDidMount 的时候执行 method(location)，也就是 history.replace 操作</span></span><br><span class="line">              method(location);</span><br><span class="line">            &#125;&#125;</span><br><span class="line">            onUpdate=&#123;(self, prevProps) =&gt; &#123;</span><br><span class="line">              <span class="comment">// componentDidUpdate 时候判断当前 location 和上一个 location 是否发生变化</span></span><br><span class="line">              <span class="comment">// 只要发生变化，调用 method(location)</span></span><br><span class="line">              <span class="comment">// 一般来讲，在 componentDidMount 的时候就跳走了，不会等到 componentDidUpdate</span></span><br><span class="line">              <span class="keyword">const</span> prevLocation = createLocation(prevProps.to);</span><br><span class="line">              <span class="keyword">if</span> (</span><br><span class="line">                !locationsAreEqual(prevLocation, &#123;</span><br><span class="line">                  ...location,</span><br><span class="line">                  key: prevLocation.key</span><br><span class="line">                &#125;)</span><br><span class="line">              ) &#123;</span><br><span class="line">                method(location);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 无效</span></span><br><span class="line">            to=&#123;to&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        );</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &lt;<span class="regexp">/RouterContext.Consumer&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Redirect;</span></span><br></pre></td></tr></table></figure>

<p>Lifecycle 不 render 任何页面，只有生命周期函数，Lifecycle 提供了 onMount， onUpdate， onUnmount 三个生命周期函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.onMount) <span class="keyword">this</span>.props.onMount.call(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate(prevProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.onUpdate) <span class="keyword">this</span>.props.onUpdate.call(<span class="keyword">this</span>, <span class="keyword">this</span>, prevProps);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.onUnmount) <span class="keyword">this</span>.props.onUnmount.call(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Lifecycle;</span><br></pre></td></tr></table></figure>

<h1 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h1><p>整个<code>react-router</code>是由<code>createBrowserHistory</code>或者<code>createHashHistory</code>来牵头，与我们的<code>React</code>组件绑定在一起，然后传递了一些属于<code>history</code>这个库的方法以及数值。当然，还有路由的匹配和渲染。</p>
<p>在<code>history</code>这个库里面又有对于路由的监听，改变等等。</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>以<code>history</code>模式做参考（也是我们重点阅读的。</p>
<h3 id="修改url"><a href="#修改url" class="headerlink" title="修改url"></a>修改url</h3><p>当<code>url</code>改变的时候，会触发写在<code>window</code>上面的监听<code>window.addEventListener(&#39;popstate&#39;, handlePop)</code>。</p>
<p>调用了我们的函数<code>handlePop</code></p>
<p>函数内部我们<code>setState</code>，修改了<code>location</code>，方便传递正确的值下去，并通过了<code>Switch</code>找出匹配的<code>Route</code>组件。</p>
<p>触发了组件的渲染。</p>
<blockquote>
<p>当然也包括我们所谓的history.push，history.repalce等等这些方法，本质上也是修改url，然后就是重复上面的步骤</p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Derrick</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://derricktel.github.io/2020/11/14/%E3%80%90%E9%87%8D%E8%AF%86%E5%89%8D%E7%AB%AF%E3%80%91React-Router%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">http://derricktel.github.io/2020/11/14/%E3%80%90%E9%87%8D%E8%AF%86%E5%89%8D%E7%AB%AF%E3%80%91React-Router%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://derricktel.github.io" target="_blank">Derrick</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/React/">React</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">源码阅读</a></div><div class="post_share"><div class="social-share" data-image="/image/cover/react.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/DerrickWechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/DerrickAlipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2021/01/22/%E3%80%8C%E5%A6%82%E4%BD%95%E7%BB%99github%E6%8F%90%E4%B8%80%E4%B8%AAPR%E3%80%8D/"><img class="prev_cover lazyload" data-src="/image/cover/github.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">「如何给开源库提一个PR」</div></div></a></div><div class="next-post pull_right"><a href="/2020/10/28/%E3%80%90%E9%9D%A2%E7%BB%8F%E3%80%912%E5%B9%B4%E5%89%8D%E7%AB%AF%E6%9D%AD%E5%B7%9E%E9%9D%A2%E8%AF%95%E9%9B%86%E5%90%88/"><img class="next_cover lazyload" data-src="/image/cover/bg.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【面经】2年前端杭州面试集合</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/09/11/【重识前端】redux源码阅读/" title="【重识前端】redux源码阅读"><img class="relatedPosts_cover lazyload"data-src="/image/cover/web.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-09-11</div><div class="relatedPosts_title">【重识前端】redux源码阅读</div></div></a></div><div class="relatedPosts_item"><a href="/2019/07/30/React-Hook-倒计时/" title="React Hook 倒计时"><img class="relatedPosts_cover lazyload"data-src="/image/cover/React.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-07-30</div><div class="relatedPosts_title">React Hook 倒计时</div></div></a></div><div class="relatedPosts_item"><a href="/2019/06/19/React-State详解/" title="React-State详解"><img class="relatedPosts_cover lazyload"data-src="/image/cover/React.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-06-19</div><div class="relatedPosts_title">React-State详解</div></div></a></div><div class="relatedPosts_item"><a href="/2020/05/20/你真的懂React-Hook吗/" title="你真的懂React Hook吗？"><img class="relatedPosts_cover lazyload"data-src="/image/cover/React.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-20</div><div class="relatedPosts_title">你真的懂React Hook吗？</div></div></a></div><div class="relatedPosts_item"><a href="/2019/09/15/装饰器(Decorator)和React高阶组件(HOC)/" title="装饰器(Decorator)和React高阶组件(HOC)"><img class="relatedPosts_cover lazyload"data-src="/image/cover/decorator.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-09-15</div><div class="relatedPosts_title">装饰器(Decorator)和React高阶组件(HOC)</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Derrick</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>